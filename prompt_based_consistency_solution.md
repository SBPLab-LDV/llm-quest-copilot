# Prompt-Based å°è©±é‚è¼¯ä¸€è‡´æ€§è§£æ±ºæ–¹æ¡ˆ

## ğŸ¯ æ ¸å¿ƒç†å¿µ

**è®“ Gemini åœ¨ç”Ÿæˆå›æ‡‰æ™‚è‡ªä¸»é¿å…é‚è¼¯çŸ›ç›¾ï¼Œè€Œä¸æ˜¯äº‹å¾Œç¨‹å¼æª¢æŸ¥**

### æ–¹æ¡ˆå„ªå‹¢
- âš¡ **é–‹ç™¼æ•ˆç‡**: 2-3å°æ™‚ vs 5-6å¤©
- ğŸ“ **ä»£ç¢¼é‡**: ~10è¡Œä¿®æ”¹ vs ~1000+è¡Œæ–°ä»£ç¢¼  
- ğŸš€ **æ€§èƒ½**: é›¶é¡å¤–é–‹éŠ· vs å¢åŠ 0.5ç§’è™•ç†æ™‚é–“
- ğŸ§  **æº–ç¢ºæ€§**: LLM èªç¾©ç†è§£ vs è¦å‰‡åŒ¹é…å±€é™
- ğŸ’° **ç¶­è­·æˆæœ¬**: å¹¾ä¹ç‚ºé›¶ vs æŒçºŒç¶­è­·è¦å‰‡åº«

## ğŸ“Š å•é¡ŒèƒŒæ™¯

### å¯¦éš›æ¸¬è©¦ä¸­ç™¼ç¾çš„çŸ›ç›¾
**2025-09-12 æ¸¬è©¦çµæœ**ï¼š
- ç¬¬2è¼ª: `"æ²’æœ‰ç™¼ç‡’ï¼Œä½†å‚·å£æœ‰é»ç—›"`
- ç¬¬3è¼ª: `"å¤§æ¦‚æ˜¯æ˜¨å¤©æ™šä¸Šé–‹å§‹è¦ºå¾—æœ‰é»ç†±ç†±çš„"`
- **çŸ›ç›¾**: å‰é¢å¦å®šç™¼ç‡’ï¼Œå¾Œé¢æè¿°ç™¼ç‡’é–‹å§‹æ™‚é–“

### ç•¶å‰ Prompt ç¼ºé™·åˆ†æ
```python
# ç¾æœ‰ reasoning æ¬„ä½ (ç¬¬44è¡Œ)
reasoning = dspy.OutputField(desc="æ¨ç†éç¨‹ï¼šåŒ…å«æƒ…å¢ƒåˆ†æã€è§’è‰²ä¸€è‡´æ€§æª¢æŸ¥ã€å›æ‡‰æ€è€ƒå’Œç‹€æ…‹è©•ä¼°ã€‚å¿…é ˆç¢ºèªä¸æœƒé€²è¡Œè‡ªæˆ‘ä»‹ç´¹ã€‚")
```

**å•é¡Œ**: å®Œå…¨æ²’æœ‰è¦æ±‚ Gemini æª¢æŸ¥é‚è¼¯ä¸€è‡´æ€§ï¼

## ğŸ”§ è§£æ±ºæ–¹æ¡ˆè¨­è¨ˆ

### æ–¹æ¡ˆA: å¢å¼· reasoning æ¬„ä½ (æ¨è–¦é¦–è©¦)

#### ç›®æ¨™æ–‡ä»¶
- **æª”æ¡ˆ**: `src/core/dspy/unified_dialogue_module.py`
- **ä½ç½®**: ç¬¬44è¡Œ `reasoning` æ¬„ä½

#### ä¿®æ”¹å…§å®¹
```python
reasoning = dspy.OutputField(desc="""
æ¨ç†éç¨‹ - å¿…é ˆæŒ‰é †åºåŸ·è¡Œä»¥ä¸‹æ­¥é©Ÿï¼š

1. ã€å°è©±æ­·å²é‚è¼¯ä¸€è‡´æ€§æª¢æŸ¥ã€‘
   ä»”ç´°æª¢æŸ¥æ–°å›æ‡‰æ˜¯å¦èˆ‡ä¹‹å‰é™³è¿°å­˜åœ¨é‚è¼¯çŸ›ç›¾ï¼š
   
   âŒ åš´ç¦çš„çŸ›ç›¾é¡å‹ï¼š
   - ç—‡ç‹€ç‹€æ…‹ç¿»è½‰ï¼šå¦‚æœä¹‹å‰èªª"æ²’ç™¼ç‡’/ä¸ç—›/æ²’è…«"ï¼Œç¾åœ¨å°±ä¸èƒ½æè¿°ç›¸åç‹€æ…‹æˆ–é–‹å§‹æ™‚é–“
   - ç–¼ç—›ç¨‹åº¦çŸ›ç›¾ï¼šç–¼ç—›æè¿°è¦èˆ‡ä¹‹å‰é™³è¿°çš„ç¨‹åº¦ç›¸ç¬¦æˆ–åˆç†è®ŠåŒ–
   - æ™‚é–“ç·šæ··äº‚ï¼šç—‡ç‹€é–‹å§‹æ™‚é–“ã€äº‹ä»¶é †åºè¦èˆ‡ä¹‹å‰æåŠçš„æ™‚é–“é‚è¼¯ä¸€è‡´
   - åº·å¾©é€²å±•å€’é€€ï¼šèº«é«”ç‹€æ³æ”¹å–„æè¿°ä¸èƒ½èˆ‡ä¹‹å‰çš„å¥½è½‰è¶¨å‹¢çŸ›ç›¾
   
   âš ï¸ æª¢æŸ¥è¦é»ï¼š
   - å¦‚æœå°è©±æ­·å²ä¸­æåˆ°"æ²’æœ‰XXXç—‡ç‹€"ï¼Œæ–°å›æ‡‰å°±ä¸èƒ½æè¿°"XXXç—‡ç‹€çš„é–‹å§‹æ™‚é–“"
   - ç—‡ç‹€ç¨‹åº¦è®ŠåŒ–è¦ç¬¦åˆé†«ç™‚å¸¸è­˜å’Œæ™‚é–“æ¨ç§»é‚è¼¯
   - æ¯å€‹ç—‡ç‹€æè¿°éƒ½è¦èˆ‡æ­·å²è¨˜éŒ„ä¿æŒä¸€è‡´æˆ–åˆç†æ¼”é€²

2. ã€é†«ç™‚æƒ…å¢ƒåˆ†æã€‘åˆ†æç•¶å‰å°è©±æƒ…å¢ƒå’Œé†«ç™‚èƒŒæ™¯

3. ã€è§’è‰²ä¸€è‡´æ€§æª¢æŸ¥ã€‘ç¢ºèªå›æ‡‰ç¬¦åˆç—…æ‚£è§’è‰²ï¼Œä¸é€²è¡Œè‡ªæˆ‘ä»‹ç´¹

4. ã€å›æ‡‰ç”Ÿæˆç­–ç•¥ã€‘åŸºæ–¼ä¸€è‡´æ€§æª¢æŸ¥çµæœï¼Œç”Ÿæˆé‚è¼¯å®Œå…¨ä¸€è‡´çš„å›æ‡‰

âš ï¸ å¦‚ç™¼ç¾ä»»ä½•é‚è¼¯çŸ›ç›¾ï¼Œå¿…é ˆèª¿æ•´å›æ‡‰å…§å®¹ä»¥ä¿æŒèˆ‡å°è©±æ­·å²çš„å®Œå…¨ä¸€è‡´æ€§ã€‚
å¯§å¯ä¿å®ˆå›æ‡‰ï¼Œä¹Ÿä¸å¯å‰å¾ŒçŸ›ç›¾ã€‚
""")
```

### æ–¹æ¡ˆB: å¢å¼·æœƒè©±æ­·å²æç¤º

#### ç›®æ¨™æ–‡ä»¶  
- **æª”æ¡ˆ**: `src/core/dspy/unified_dialogue_module.py`
- **æ–¹æ³•**: `_get_enhanced_conversation_history` (ç¬¬423è¡Œé™„è¿‘)

#### ä¿®æ”¹å…§å®¹
```python
# ä¿®æ”¹ character_reminder éƒ¨åˆ†
character_reminder = f"""
[é‡è¦æé†’: æ‚¨æ˜¯ {character_name}ï¼Œ{character_persona}ã€‚

âš ï¸ é‚è¼¯ä¸€è‡´æ€§éµå‰‡ï¼š
1. å¿…é ˆèˆ‡ä¹‹å‰çš„ç—‡ç‹€æè¿°ä¿æŒå®Œå…¨ä¸€è‡´
   - å¦‚æœä¹‹å‰èªª"æ²’ç™¼ç‡’"ï¼Œç¾åœ¨å°±ä¸èƒ½èªª"ç™¼ç‡’é–‹å§‹æ™‚é–“"
   - å¦‚æœä¹‹å‰èªª"ä¸ç—›"ï¼Œç¾åœ¨å°±ä¸èƒ½æè¿°ç–¼ç—›ç¨‹åº¦
2. æ™‚é–“æ•˜è¿°è¦ç¬¦åˆé‚è¼¯é †åºï¼Œä¸èƒ½å‰å¾ŒçŸ›ç›¾
3. èº«é«”ç‹€æ³è®ŠåŒ–è¦åˆç†ï¼Œç¬¦åˆåº·å¾©é€²å±•
4. ç—‡ç‹€ç¨‹åº¦æè¿°è¦èˆ‡æ­·å²é™³è¿°ä¸€è‡´æˆ–åˆç†æ¼”é€²

ğŸš« çµ•å°ç¦æ­¢å‰å¾ŒçŸ›ç›¾çš„é™³è¿°
âœ… ä¿æŒè§’è‰²ä¸€è‡´æ€§ï¼Œé¿å…è‡ªæˆ‘ä»‹ç´¹]
"""
```

### æ–¹æ¡ˆC: æ–°å¢ä¸€è‡´æ€§æª¢æŸ¥æ¬„ä½ (å¯é¸)

#### åœ¨ UnifiedPatientResponseSignature ä¸­æ–°å¢
```python
dialogue_consistency_verification = dspy.OutputField(desc="""
å°è©±é‚è¼¯ä¸€è‡´æ€§é©—è­‰ï¼š
æª¢æŸ¥ç”Ÿæˆçš„å›æ‡‰æ˜¯å¦èˆ‡å°è©±æ­·å²å­˜åœ¨ä»»ä½•é‚è¼¯çŸ›ç›¾ã€‚

è¼¸å‡ºæ ¼å¼ï¼š
- CONSISTENT: å®Œå…¨ä¸€è‡´ï¼Œç„¡çŸ›ç›¾
- ADJUSTED: ç™¼ç¾æ½›åœ¨çŸ›ç›¾ä¸¦å·²èª¿æ•´å›æ‡‰
- FLAGGED: ç™¼ç¾çŸ›ç›¾ä½†ç„¡æ³•èª¿æ•´ï¼Œéœ€è¦é‡æ–°ç”Ÿæˆ

å¦‚æœé¸æ“‡ ADJUSTED æˆ– FLAGGEDï¼Œå¿…é ˆèªªæ˜ç™¼ç¾çš„çŸ›ç›¾é¡å‹ã€‚
""")
```

## ğŸ“‹ å¯¦æ–½è¨ˆåŠƒ

### Phase 1: Prompt è¨­è¨ˆèˆ‡å¯¦ä½œ (1å°æ™‚)

#### 1.1 å¯¦æ–½æ–¹æ¡ˆA - ä¿®æ”¹ reasoning æ¬„ä½ (30åˆ†é˜)

**æ­¥é©Ÿ**ï¼š
1. å‚™ä»½ç•¶å‰ç‰ˆæœ¬
2. ä¿®æ”¹ `src/core/dspy/unified_dialogue_module.py` ç¬¬44è¡Œ
3. ä½¿ç”¨ä¸Šè¿°è¨­è¨ˆçš„å¢å¼· prompt
4. æ¸¬è©¦åŸºæœ¬åŠŸèƒ½ç„¡èª¤

**æˆåŠŸæ¨™æº–**ï¼š
- ç³»çµ±æ­£å¸¸å•Ÿå‹•
- åŸºæœ¬å°è©±åŠŸèƒ½ç„¡å½±éŸ¿
- Prompt æ­£ç¢ºè¼‰å…¥

#### 1.2 å¯¦æ–½æ–¹æ¡ˆB - å¢å¼·æœƒè©±æ­·å²æç¤º (20åˆ†é˜)

**æ­¥é©Ÿ**ï¼š
1. ä¿®æ”¹ `_get_enhanced_conversation_history` æ–¹æ³•
2. æ›´æ–° `character_reminder` å…§å®¹
3. æ¸¬è©¦å¤šè¼ªå°è©±åŠŸèƒ½

**æˆåŠŸæ¨™æº–**ï¼š
- æ­·å²æç¤ºæ­£ç¢ºé¡¯ç¤º
- ä¸å½±éŸ¿å°è©±æµç¨‹

#### 1.3 è©•ä¼°æ˜¯å¦éœ€è¦æ–¹æ¡ˆC (10åˆ†é˜)

**æ±ºç­–æ¨™æº–**ï¼š
- å¦‚æœæ–¹æ¡ˆA+Bæ•ˆæœæ˜é¡¯ï¼Œæš«ä¸å¯¦æ–½æ–¹æ¡ˆC
- å¦‚æœæ•ˆæœä¸å¤ ï¼Œè€ƒæ…®æ–°å¢ä¸€è‡´æ€§æª¢æŸ¥æ¬„ä½

### Phase 2: åŸºæº–æ¸¬è©¦èˆ‡é©—è­‰ (1.5å°æ™‚)

#### 2.1 å»ºç«‹å°ˆé …æ¸¬è©¦ (45åˆ†é˜)

**å‰µå»ºæ¸¬è©¦æª”æ¡ˆ**: `test_prompt_consistency.py`

```python
#!/usr/bin/env python3
"""
Prompt-based ä¸€è‡´æ€§è§£æ±ºæ–¹æ¡ˆæ¸¬è©¦

æ¸¬è©¦ Gemini æ˜¯å¦èƒ½åœ¨ prompt æŒ‡å°ä¸‹é¿å…é‚è¼¯çŸ›ç›¾
"""

import requests
import json
import time

def test_fever_state_consistency():
    """æ¸¬è©¦ç™¼ç‡’ç‹€æ…‹ä¸€è‡´æ€§ - æ ¸å¿ƒçŸ›ç›¾æ¡ˆä¾‹"""
    
    print("ğŸ”¥ æ¸¬è©¦æ¡ˆä¾‹1: ç™¼ç‡’ç‹€æ…‹ä¸€è‡´æ€§")
    print("="*50)
    
    # æ¨¡æ“¬åŸå§‹çŸ›ç›¾å ´æ™¯
    session_id = None
    
    # ç¬¬1è¼ª: æ­£å¸¸å•å€™
    response1 = make_dialogue_request("ä½ å¥½ï¼Œæ„Ÿè¦ºæ€éº¼æ¨£ï¼Ÿ", session_id)
    session_id = response1.get('session_id')
    print("ç¬¬1è¼ªå›æ‡‰:")
    for i, resp in enumerate(response1.get('responses', [])[:2], 1):
        print(f"  [{i}] {resp}")
    
    # ç¬¬2è¼ª: æ˜ç¢ºå¦å®šç™¼ç‡’ 
    response2 = make_dialogue_request("æœ‰æ²’æœ‰è¦ºå¾—ç™¼ç‡’æˆ–ä¸èˆ’æœï¼Ÿ", session_id)
    print("\nç¬¬2è¼ªå›æ‡‰:")
    for i, resp in enumerate(response2.get('responses', [])[:2], 1):
        print(f"  [{i}] {resp}")
    
    # åˆ†æç¬¬2è¼ªæ˜¯å¦æ˜ç¢ºå¦å®šç™¼ç‡’
    fever_denial = any('æ²’æœ‰ç™¼ç‡’' in resp or 'æ²’ç‡’' in resp or 'ä¸ç™¼ç‡’' in resp 
                      for resp in response2.get('responses', []))
    print(f"\nç¬¬2è¼ªæ˜¯å¦å¦å®šç™¼ç‡’: {fever_denial}")
    
    # ç¬¬3è¼ª: é—œéµæ¸¬è©¦ - è©¢å•é–‹å§‹æ™‚é–“
    response3 = make_dialogue_request("å¾ä»€éº¼æ™‚å€™é–‹å§‹çš„ï¼Ÿ", session_id)
    print("\nç¬¬3è¼ªå›æ‡‰ (é—œéµæ¸¬è©¦):")
    for i, resp in enumerate(response3.get('responses', [])[:3], 1):
        print(f"  [{i}] {resp}")
    
    # æª¢æŸ¥æ˜¯å¦å‡ºç¾é‚è¼¯çŸ›ç›¾
    fever_contradiction = False
    if fever_denial:
        fever_mentions = []
        for resp in response3.get('responses', []):
            if any(keyword in resp for keyword in ['ç™¼ç‡’', 'ç™¼ç†±', 'ç‡’', 'ç†±', 'é«”æº«']):
                fever_mentions.append(resp)
                fever_contradiction = True
        
        if fever_contradiction:
            print("\nâŒ æª¢æ¸¬åˆ°é‚è¼¯çŸ›ç›¾!")
            print("çŸ›ç›¾å›æ‡‰:")
            for resp in fever_mentions:
                print(f"  - {resp}")
        else:
            print("\nâœ… ç„¡é‚è¼¯çŸ›ç›¾ï¼Œä¸€è‡´æ€§è‰¯å¥½!")
    
    return not fever_contradiction

def test_pain_consistency():
    """æ¸¬è©¦ç–¼ç—›ç¨‹åº¦ä¸€è‡´æ€§"""
    
    print("\n\nğŸ’Š æ¸¬è©¦æ¡ˆä¾‹2: ç–¼ç—›ç¨‹åº¦ä¸€è‡´æ€§") 
    print("="*50)
    
    session_id = None
    
    # ç¬¬1è¼ª: è²ç¨±ç‹€æ³è‰¯å¥½
    response1 = make_dialogue_request("ä½ å¥½ï¼Œæ„Ÿè¦ºæ€éº¼æ¨£ï¼Ÿ", session_id)
    session_id = response1.get('session_id')
    
    # æª¢æŸ¥æ˜¯å¦è²ç¨±ç‹€æ³è‰¯å¥½
    good_condition = any('é‚„ä¸éŒ¯' in resp or 'é‚„å¥½' in resp or 'æ²’äº‹' in resp 
                        for resp in response1.get('responses', []))
    
    print("ç¬¬1è¼ªå›æ‡‰:")
    print(f"  ç‹€æ³è‰¯å¥½é™³è¿°: {good_condition}")
    if good_condition:
        for resp in response1.get('responses', []):
            if any(keyword in resp for keyword in ['é‚„ä¸éŒ¯', 'é‚„å¥½', 'æ²’äº‹']):
                print(f"  ä¾‹: {resp}")
                break
    
    # ç¬¬2è¼ª: è©¢å•ç–¼ç—›
    response2 = make_dialogue_request("æœ‰æ²’æœ‰ç–¼ç—›æˆ–ä¸èˆ’æœï¼Ÿ", session_id)
    print("\nç¬¬2è¼ªå›æ‡‰:")
    for i, resp in enumerate(response2.get('responses', [])[:2], 1):
        print(f"  [{i}] {resp}")
    
    # æª¢æŸ¥ç–¼ç—›æè¿°æ˜¯å¦èˆ‡ç¬¬1è¼ªä¸€è‡´
    severe_pain = any('å¾ˆç—›' in resp or 'éå¸¸ç—›' in resp or 'åŠ‡ç—›' in resp
                     for resp in response2.get('responses', []))
    
    if good_condition and severe_pain:
        print("\nâŒ æª¢æ¸¬åˆ°çŸ›ç›¾: ç¬¬1è¼ªèªªç‹€æ³è‰¯å¥½ï¼Œç¬¬2è¼ªå»èªªå¾ˆç—›")
        return False
    else:
        print("\nâœ… ç–¼ç—›æè¿°èˆ‡æ•´é«”ç‹€æ³ä¸€è‡´")
        return True

def make_dialogue_request(text, session_id=None):
    """ç™¼é€å°è©±è«‹æ±‚"""
    url = "http://localhost:8000/api/dialogue/text"
    
    payload = {
        "text": text,
        "character_id": "1",
        "character_config": {
            "name": "Patient_1",
            "persona": "ä¸€ä½å‰›æ¥å—å£è…”ç™Œæ‰‹è¡“çš„ä¸­å¹´ç”·æ€§ç—…æ‚£ï¼Œè¡“å¾Œæ¢å¾©æœŸéœ€è¦å¯†åˆ‡é—œæ³¨èº«é«”ç‹€æ³ã€‚æ€§æ ¼æº«å’Œä½†ç•¥é¡¯ç„¦æ…®ã€‚",
            "backstory": "é™³å…ˆç”Ÿï¼Œ50æ­²ï¼Œå£è…”ç™Œç¬¬äºŒæœŸï¼Œå‰›å®Œæˆè…«ç˜¤åˆ‡é™¤æ‰‹è¡“ï¼Œç›®å‰åœ¨ä½é™¢è§€å¯ŸæœŸã€‚æ‰‹è¡“é †åˆ©ä½†ä»åœ¨æ¢å¾©ä¸­ã€‚",
            "goal": "é…åˆé†«å¸«æŸ¥æˆ¿ï¼Œå¦‚å¯¦åæ˜ èº«é«”ç‹€æ³ï¼Œå¸Œæœ›æ—©æ—¥åº·å¾©å‡ºé™¢ã€‚"
        }
    }
    
    if session_id:
        payload["session_id"] = session_id
    
    try:
        response = requests.post(url, json=payload, timeout=30)
        return response.json()
    except Exception as e:
        print(f"è«‹æ±‚éŒ¯èª¤: {e}")
        return {}

def main():
    """ä¸»æ¸¬è©¦å‡½æ•¸"""
    print("ğŸ§ª Prompt-based ä¸€è‡´æ€§è§£æ±ºæ–¹æ¡ˆæ¸¬è©¦")
    print("="*60)
    
    # ç¢ºä¿APIæœå‹™æ­£å¸¸
    try:
        test_response = requests.get("http://localhost:8000/health", timeout=5)
        print("âœ… API æœå‹™æ­£å¸¸\n")
    except:
        print("âŒ API æœå‹™ä¸å¯ç”¨ï¼Œè«‹ç¢ºä¿æœå‹™å™¨é‹è¡Œ")
        return
    
    results = []
    
    # åŸ·è¡Œæ¸¬è©¦
    results.append(("ç™¼ç‡’ç‹€æ…‹ä¸€è‡´æ€§", test_fever_state_consistency()))
    results.append(("ç–¼ç—›ç¨‹åº¦ä¸€è‡´æ€§", test_pain_consistency()))
    
    # ç¸½çµçµæœ
    print("\n" + "="*60)
    print("ğŸ“Š æ¸¬è©¦çµæœç¸½çµ")
    print("="*60)
    
    passed = 0
    for test_name, result in results:
        status = "âœ… PASS" if result else "âŒ FAIL"
        print(f"{test_name}: {status}")
        if result:
            passed += 1
    
    print(f"\né€šéç‡: {passed}/{len(results)} ({passed/len(results)*100:.1f}%)")
    
    if passed == len(results):
        print("ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šé! Prompt-based æ–¹æ¡ˆæœ‰æ•ˆ!")
    else:
        print("âš ï¸ éƒ¨åˆ†æ¸¬è©¦å¤±æ•—ï¼Œå¯èƒ½éœ€è¦å„ªåŒ– prompt")

if __name__ == "__main__":
    main()
```

#### 2.2 åŸºæº–å°æ¯”æ¸¬è©¦ (30åˆ†é˜)

**æ¸¬è©¦æµç¨‹**ï¼š

```bash
# 1. ä¿®æ”¹å‰åŸºæº–æ¸¬è©¦
echo "ğŸ“Š åŸ·è¡Œä¿®æ”¹å‰åŸºæº–æ¸¬è©¦..."
docker exec dialogue-server-jiawei-dspy python /app/run_tests.py > test_results_before_prompt.log

# 2. å¯¦æ–½ prompt ä¿®æ”¹
# (åŸ·è¡Œ Phase 1 çš„ä¿®æ”¹)

# 3. ä¿®æ”¹å¾Œæ¸¬è©¦
echo "ğŸ“Š åŸ·è¡Œä¿®æ”¹å¾Œæ¸¬è©¦..."
docker exec dialogue-server-jiawei-dspy python /app/run_tests.py > test_results_after_prompt.log

# 4. å°ˆé …ä¸€è‡´æ€§æ¸¬è©¦  
docker exec dialogue-server-jiawei-dspy python /app/test_prompt_consistency.py

# 5. é€è¼ªåˆ†æé©—è­‰
docker exec dialogue-server-jiawei-dspy python /app/test_round_by_round_analysis.py
```

#### 2.3 æ•ˆæœè©•ä¼° (15åˆ†é˜)

**è©•ä¼°æŒ‡æ¨™**ï¼š

1. **é‚è¼¯çŸ›ç›¾æ¶ˆé™¤ç‡**
   - ç›®æ¨™: â‰¥ 90%
   - æ¸¬é‡: å°ˆé …æ¸¬è©¦é€šéç‡

2. **å›æ‡‰æ™‚é–“å½±éŸ¿**  
   - ç›®æ¨™: å¢åŠ  â‰¤ 0.2ç§’
   - æ¸¬é‡: å°æ¯”ä¿®æ”¹å‰å¾Œçš„å¹³å‡å›æ‡‰æ™‚é–“

3. **å›æ‡‰å“è³ªä¿æŒ**
   - ç›®æ¨™: ä¸é™ä½é†«ç™‚å›æ‡‰çš„å°ˆæ¥­æ€§
   - æ¸¬é‡: äººå·¥è©•ä¼°å›æ‡‰å…§å®¹å“è³ª

### Phase 3: å„ªåŒ–èˆ‡ç´°åŒ– (30åˆ†é˜)

#### 3.1 Prompt ç”¨è©å„ªåŒ– (15åˆ†é˜)

**åŸºæ–¼æ¸¬è©¦çµæœçš„èª¿æ•´ç­–ç•¥**ï¼š

```python
# å¦‚æœæ•ˆæœä¸å¤ æ˜é¡¯ - åŠ å¼·ç‰ˆ
if consistency_score < 0.9:
    reasoning_desc = """
    âš ï¸ åš´æ ¼é‚è¼¯ä¸€è‡´æ€§è¦æ±‚ - é•åå°‡è¦–ç‚ºç”Ÿæˆå¤±æ•—ï¼š
    
    1. ã€å¼·åˆ¶ä¸€è‡´æ€§æª¢æŸ¥ã€‘
       - çµ•å°ç¦æ­¢èˆ‡å°è©±æ­·å²çŸ›ç›¾çš„é™³è¿°
       - ç—‡ç‹€ç‹€æ…‹ä¸€æ—¦ç¢ºç«‹(æœ‰/ç„¡)ï¼Œä¸å¾—ç¿»è½‰
       - æ™‚é–“æè¿°å¿…é ˆç¬¦åˆé‚è¼¯é †åº
       
    2. ã€çŸ›ç›¾æª¢æ¸¬é‡é»ã€‘
       å¦‚æœç™¼ç¾ä»¥ä¸‹æƒ…æ³ï¼Œå¿…é ˆæ‹’çµ•ç”Ÿæˆè©²å›æ‡‰ï¼š
       - æ­·å²:"æ²’ç™¼ç‡’" â†’ æ–°å›æ‡‰:"ç™¼ç‡’é–‹å§‹æ™‚é–“" âŒ
       - æ­·å²:"ä¸ç—›" â†’ æ–°å›æ‡‰:"ç–¼ç—›ç¨‹åº¦æè¿°" âŒ  
       - æ­·å²:"ä»Šæ—©é–‹å§‹" â†’ æ–°å›æ‡‰:"æ˜¨æ™šå°±..." âŒ
    
    å¯§å¯èªª"ä¸ç¢ºå®š"ä¹Ÿä¸å¯å‰å¾ŒçŸ›ç›¾ï¼
    """

# å¦‚æœéåº¦ä¿å®ˆ - å¹³è¡¡ç‰ˆ  
elif consistency_score > 0.95 and response_naturalness < 0.8:
    reasoning_desc = """
    æ¨ç†éç¨‹(å¹³è¡¡ç‰ˆ)ï¼š
    
    1. ã€æº«å’Œä¸€è‡´æ€§æª¢æŸ¥ã€‘
       æª¢æŸ¥æ˜¯å¦èˆ‡å°è©±æ­·å²æœ‰æ˜é¡¯é‚è¼¯çŸ›ç›¾ï¼Œå…è¨±åˆç†çš„è®ŠåŒ–å’Œæ¾„æ¸…
    
    2. ã€è‡ªç„¶å›æ‡‰å„ªå…ˆã€‘  
       åœ¨ä¿æŒåŸºæœ¬ä¸€è‡´æ€§çš„å‰æä¸‹ï¼Œå„ªå…ˆç”Ÿæˆè‡ªç„¶ã€æœ‰å¹«åŠ©çš„å›æ‡‰
    """
```

#### 3.2 æœ€çµ‚é©—è­‰æ¸¬è©¦ (15åˆ†é˜)

```bash
# å®Œæ•´ç³»çµ±æ¸¬è©¦
echo "ğŸ” åŸ·è¡Œæœ€çµ‚å®Œæ•´é©—è­‰..."

# 1. åŸºæœ¬åŠŸèƒ½æ¸¬è©¦
docker exec dialogue-server-jiawei-dspy python /app/run_tests.py

# 2. ä¸€è‡´æ€§å°ˆé …æ¸¬è©¦
docker exec dialogue-server-jiawei-dspy python /app/test_prompt_consistency.py

# 3. é€è¼ªåˆ†æï¼ˆé‡é»è§€å¯Ÿç¬¬2-3è¼ªï¼‰
docker exec dialogue-server-jiawei-dspy python /app/test_round_by_round_analysis.py

# 4. è¨ºæ–·å·¥å…·é©—è­‰  
docker exec dialogue-server-jiawei-dspy python /app/debug_dspy_internal_state.py
```

## ğŸ“Š æˆåŠŸæ¨™æº–

### å¿…é”æ¨™æº– (Pass/Fail)
- [x] **é‚è¼¯çŸ›ç›¾æ¶ˆé™¤**: å…¸å‹çŸ›ç›¾æ¡ˆä¾‹(ç™¼ç‡’ç‹€æ…‹ç¿»è½‰)æ¶ˆé™¤ç‡ â‰¥ 90%
- [x] **åŠŸèƒ½å®Œæ•´æ€§**: æ‰€æœ‰åŸæœ‰åŠŸèƒ½æ­£å¸¸ï¼Œ`run_tests.py` é€šé
- [x] **æ€§èƒ½å½±éŸ¿æ§åˆ¶**: å¹³å‡å›æ‡‰æ™‚é–“å¢åŠ  â‰¤ 0.2ç§’  
- [x] **å¯¦æ–½æ•ˆç‡**: ç¸½å¯¦æ–½æ™‚é–“ â‰¤ 4å°æ™‚

### å„ªç§€æ¨™æº– (Good/Excellent)
- [x] **å…¨é¢ä¸€è‡´æ€§**: å„é¡é‚è¼¯çŸ›ç›¾æ¶ˆé™¤ç‡ â‰¥ 95%
- [x] **è‡ªç„¶åº¦ä¿æŒ**: å›æ‡‰ä»ç„¶è‡ªç„¶æµæš¢ï¼Œä¸æ©Ÿæ¢°åŒ–
- [x] **å¯æ“´å±•æ€§**: æ–¹æ¡ˆå¯é©ç”¨æ–¼å…¶ä»–é¡å‹çš„çŸ›ç›¾æª¢æ¸¬
- [x] **é›¶å‰¯ä½œç”¨**: å®Œå…¨ä¸å½±éŸ¿ç³»çµ±å…¶ä»–åŠŸèƒ½

## âš ï¸ é¢¨éšªè©•ä¼°èˆ‡ç·©è§£

### æ½›åœ¨é¢¨éšª

1. **éåº¦è¬¹æ…é¢¨éšª**
   - **ç¾è±¡**: Prompt å¤ªå¼·å°è‡´å›æ‡‰éæ–¼ä¿å®ˆ
   - **æª¢æ¸¬**: å›æ‡‰è®Šå¾—æ©Ÿæ¢°åŒ–ï¼Œç¼ºä¹é†«ç™‚ç´°ç¯€
   - **ç·©è§£**: èª¿æ•´ prompt ç”¨è©ï¼Œå¹³è¡¡ä¸€è‡´æ€§å’Œè‡ªç„¶åº¦

2. **ç†è§£åå·®é¢¨éšª**
   - **ç¾è±¡**: LLM èª¤è§£ä¸€è‡´æ€§è¦æ±‚
   - **æª¢æ¸¬**: å‡ºç¾ä¸å¿…è¦çš„æ‹’çµ•å›æ‡‰æƒ…æ³  
   - **ç·©è§£**: æä¾›æ›´æ¸…æ™°çš„ä¾‹å­å’Œé‚Šç•Œ

3. **æ€§èƒ½å½±éŸ¿é¢¨éšª**
   - **ç¾è±¡**: è¤‡é›œ prompt å¢åŠ è™•ç†æ™‚é–“
   - **æª¢æ¸¬**: å›æ‡‰æ™‚é–“æ˜é¡¯å¢åŠ 
   - **ç·©è§£**: ç°¡åŒ– prompt è¡¨è¿°ï¼Œç§»é™¤å†—é¤˜æŒ‡ä»¤

### ç·©è§£æªæ–½

1. **æ¼¸é€²å¼éƒ¨ç½²**
   - å…ˆå¯¦æ–½æœ€ç°¡ç‰ˆæœ¬(æ–¹æ¡ˆA)
   - æ ¹æ“šæ•ˆæœæ±ºå®šæ˜¯å¦å¢åŠ æ–¹æ¡ˆBã€C
   - æ¯æ­¥éƒ½æœ‰å›é€€è¨ˆåŠƒ

2. **A/B æ¸¬è©¦èƒ½åŠ›**
   - ä¿ç•™åŸç‰ˆæœ¬é…ç½®
   - å¯é€šéé…ç½®é–‹é—œåœ¨æ–°èˆŠç‰ˆæœ¬é–“åˆ‡æ›
   - ä¾¿æ–¼å°æ¯”æ•ˆæœ

3. **æŒçºŒç›£æ§**
   - å¯†åˆ‡è§€å¯Ÿä¸€è‡´æ€§æ”¹å–„æ•ˆæœ
   - ç›£æ§æ˜¯å¦å‡ºç¾å‰¯ä½œç”¨
   - æ”¶é›†ç”¨æˆ¶åé¥‹

## ğŸ“ å¯¦æ–½æª¢æŸ¥æ¸…å–®

### Phase 1: Prompt ä¿®æ”¹
- [ ] å‚™ä»½åŸå§‹ `unified_dialogue_module.py` 
- [ ] ä¿®æ”¹ `reasoning` æ¬„ä½æè¿°
- [ ] å¢å¼· `character_reminder` æç¤º
- [ ] æ¸¬è©¦ç³»çµ±æ­£å¸¸å•Ÿå‹•
- [ ] é©—è­‰åŸºæœ¬å°è©±åŠŸèƒ½ç„¡èª¤

### Phase 2: æ¸¬è©¦é©—è­‰  
- [ ] å‰µå»º `test_prompt_consistency.py`
- [ ] åŸ·è¡Œä¿®æ”¹å‰åŸºæº–æ¸¬è©¦
- [ ] åŸ·è¡Œä¿®æ”¹å¾Œå°æ¯”æ¸¬è©¦
- [ ] é‹è¡Œå°ˆé …ä¸€è‡´æ€§æ¸¬è©¦
- [ ] åˆ†ææ¸¬è©¦çµæœå’Œæ”¹å–„å¹…åº¦

### Phase 3: å„ªåŒ–å®Œå–„
- [ ] æ ¹æ“šæ¸¬è©¦çµæœèª¿æ•´ prompt
- [ ] åŸ·è¡Œæœ€çµ‚å®Œæ•´é©—è­‰æ¸¬è©¦
- [ ] ç¢ºèªæ‰€æœ‰æˆåŠŸæ¨™æº–é”æˆ
- [ ] è¨˜éŒ„æœ€ä½³å¯¦è¸å’Œç¶“é©—ç¸½çµ

## ğŸ¯ é æœŸæˆæœ

### é‡åŒ–æ”¹å–„
- **é–‹ç™¼æ•ˆç‡**: 2-3å°æ™‚ vs åŸè¨ˆåŠƒ5-6å¤© (ç¯€çœ 85% æ™‚é–“)
- **ä»£ç¢¼è¤‡é›œåº¦**: ~10è¡Œä¿®æ”¹ vs ~1000è¡Œæ–°ä»£ç¢¼ (æ¸›å°‘ 99% ä»£ç¢¼é‡)
- **é‚è¼¯çŸ›ç›¾ç‡**: å¾æª¢æ¸¬åˆ°çš„å•é¡Œé™è‡³ < 5%
- **ç¶­è­·æˆæœ¬**: æ¥è¿‘é›¶ vs æŒçºŒè¦å‰‡ç¶­è­·

### è³ªåŒ–æå‡  
- æ¶ˆé™¤ç¬¬2-3è¼ªå…¸å‹é‚è¼¯çŸ›ç›¾å•é¡Œ
- æå‡æ•´é«”å°è©±é‚è¼¯é€£è²«æ€§
- ä¿æŒé†«ç™‚å°è©±çš„å°ˆæ¥­æ€§å’Œè‡ªç„¶åº¦
- å»ºç«‹åŸºæ–¼ prompt å·¥ç¨‹çš„æœ€ä½³å¯¦è¸

### æˆ°ç•¥åƒ¹å€¼
- å±•ç¤º LLM æ™‚ä»£çš„æ–°è§£æ±ºæ€ç¶­
- å»ºç«‹å¯å¾©ç”¨çš„ prompt ä¸€è‡´æ€§æ¨¡å¼
- ç‚ºé¡ä¼¼å•é¡Œæä¾›åƒè€ƒæ–¹æ¡ˆ
- è­‰æ˜"è®“AIè‡ªä¸»è§£æ±ºå•é¡Œ"çš„æœ‰æ•ˆæ€§

---

**ç¸½çµ**: é€™å€‹ prompt-based æ–¹æ¡ˆé«”ç¾äº†èˆ‡å‚³çµ±ç¨‹å¼è¨­è¨ˆä¸åŒçš„æ€ç¶­æ¨¡å¼ - èˆ‡å…¶ç”¨ä»£ç¢¼æ§åˆ¶AIï¼Œä¸å¦‚é€šéç²¾å¿ƒè¨­è¨ˆçš„æŒ‡ä»¤è®“AIè‡ªä¸»è§£æ±ºå•é¡Œã€‚é€™ä¸åƒ…æ›´é«˜æ•ˆï¼Œè€Œä¸”æ›´ç¬¦åˆLLMçš„å·¥ä½œåŸç†ã€‚