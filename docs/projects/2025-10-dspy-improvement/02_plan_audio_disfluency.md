**口語表達（ASR→句子選項）改善規劃**

更新日期：2025-10-15
範圍：音訊多模態路徑（語音→original/options JSON）之品質改善，遵循「DSPy First & Prompt-based」原則。

—

**現況診斷（摘自測試與程式）**
- 只辨識片段、關鍵意圖遺失（例：「嗆..到..回...家」只變成「回家」），造成答非所問。
- 多意圖未覆蓋（例：「嘴、痛、睡不著」只回應睡不著）。
- 情境錯位（模板硬假設住院，門診/出院情境被誤導）。
- 用語過專業，偏離病人口語（如出現 PCA、專業術語）。
- 缺少「限制/安全」護欄（若個案不能吞嚥/口進食/說話，仍可能產生不適切選項）。
- 關聯程式：
  - 模板：`prompts/templates/audio_disfluency_template.yaml:11`（住院先驗）、:39–43（專有名詞優先）
  - DSPy 組裝：`src/core/dspy/audio_modules.py:17`（AudioPromptComposerModule）
  - 規則片段：`src/core/audio/context_utils.py:58`（build_audio_template_rules）
  - 多模態呼叫：`src/llm/gemini_client.py:260`

—

**改善原則**
- Prompt-first：優先以模板與提示規則修正；維持輸出 JSON 形狀（original、options）。
- 情境導向：從【角色摘要】與【近期對話】推導場域與限制，不再硬性假設住院。
- 多意圖覆蓋：一句含多意圖時，options 需分別覆蓋主要意圖。
- 口語化：避免專業術語，使用病人常用說法。
- 安全護欄：若個案限制存在（不能說話/吞嚥/口進食/下床…），嚴禁違反限制的選項。

—

**改動清單（含前後差異與推理鏈）**

1) 移除「硬性住院」先驗，改為情境由角色摘要決定
- 位置與變更：
  - 原文：`prompts/templates/audio_disfluency_template.yaml:11`「正在住院中，位於醫療監護環境」
  - 新文：改為「場域與限制請嚴格依【角色摘要】與【近期對話】判斷；不得擅自假設住院或可下床/可口進食。」
- 預期前後差異：
  - Before：門診/出院個案仍出現「想出院/病房流程」選項。
  - After：門診、出院個案不再出現病房/出院流程化內容；選項貼合當前場域。
- 推理鏈：
  - 問題起源於模板先驗（住院）；刪除先驗→模型從【角色摘要】與歷史判斷場域→降低錯位。

2) 新增「臨床限制一致性」規則
- 新增段落（模板「重要原則」下）：
  - 「若【角色摘要】或【近期對話】提及『不能說話/吞嚥/下床/口進食/鼻胃管/氣切』等限制：
     - options 不得包含違反限制的動作或請求；
     - 若不確定限制是否存在，避免提出具風險的動作（例如吞嚥、口服）。」
- 預期前後差異：
  - Before：ICU 舌癌術後仍出現「可說話/可吞嚥/可口進食/可下床」。
  - After：此類不可能或不安全選項被消除。
- 推理鏈：
  - 將限制顯式化為規則→LLM 在生成時做內容約束→降低不安全建議。

3) 多意圖覆蓋與關鍵詞保全
- 新增規則：
  - 「請偵測輸入中的主要意圖（如痛、睡不著、嗆到、藥物、如廁…）；若同時出現多意圖，
     options 應覆蓋不同意圖（至少各 1 句）。」
  - 「original 必須保留關鍵詞，不可丟失核心詞（如『嗆到』、『藥』、『痛』）；若輸入含省略或破碎，允許溫和重建但不得臆造新意。」
- 預期前後差異：
  - Before：「嘴、痛、睡不著」只聚焦於睡不著。
  - After：至少一個選項針對「痛」，至少一個針對「睡不著」。
- 推理鏈：
  - 以提示層強化 coverage 與保全→LLM 在生成多樣化選項時兼顧多意圖。

4) 口語化用語指引（病人視角）
- 新增規則：
  - 「避免專業縮寫與術語（如 PCA、醫囑流程）；使用病人常見說法（如『止痛藥』、『口很乾』、『吞不下』）。」
  - 「每句單句完成、自然、禮貌，描述需求/感受/具體請求。」
- 預期前後差異：
  - Before：選項出現專業用語與流程說明。
  - After：選項貼近日常、易於病人選擇。
- 推理鏈：
  - 語氣在模板層矯正→模型生成風格更口語。

5) 輸出格式與相容性（保持 original/options 形狀）
- 仍維持 `{ "original": str, "options": [str, str, str, str] }`；
  可選擇性在 JSON 增加 `meta`（如 `detected_intents`、`intent_coverage`），後端僅使用 original/options，不破壞相容性（`src/llm/gemini_client.py:303` 的解析容忍其他鍵）。
- 預期前後差異：
  - Before：僅有 options，無法驗證覆蓋度。
  - After：若開啟 `meta`，便於日誌分析覆蓋與限制遵守；不影響 UI 顯示。
- 推理鏈：
  - 增加可觀測訊號以支援測試規範（意圖覆蓋/反模板化），同時保持兼容。

6) 規則片段（build_audio_template_rules）同步加強
- 位置：`src/core/audio/context_utils.py:58`
- 新增文字：
  - 「options 需覆蓋輸入中不同意圖；
     嚴格服從【角色摘要】/【近期對話】之限制，不得提出違反限制的動作。」
- 預期前後差異：
  - Before：規則僅要求完整句與貼合醫療情境。
  - After：模型在任何情境都會被再次提醒覆蓋與限制。
- 推理鏈：
  - 在兩處（模板與規則片段）同時施壓→提升遵循度。

—

**前後差異示例（重點案例）**

案例 A：嗆..到..回...家（鄭美玲）
- Before
  - original: 「回家」
  - options: 偏向出院/返家話題，未處理嗆到。
- After
  - original: 「吃東西容易嗆到，回家應該怎麼辦？」
  - options:
    - 「我吃東西常嗆到，回家要怎麼避免？」
    - 「我需要吞嚥訓練或姿勢調整的建議。」
    - 「喝水會嗆到，有沒有其他方式潤喉？」
    - 「我擔心在家嗆到，能教我注意事項嗎？」

案例 B：回家…藥..（許雅雯）
- Before
  - original: 「回家」或「藥」片段
  - options: 與住院用藥/喝水配藥混淆。
- After
  - original: 「回家後的用藥問題想請教。」
  - options:
    - 「回家後要怎麼按時吃藥？」
    - 「哪些藥可能讓我想吐？」
    - 「如果忘了吃藥，該怎麼補吃？」
    - 「回家備藥和保存需要注意什麼？」

案例 C：嘴、痛、睡不著（王大華，多意圖）
- Before
  - options: 僅針對睡不著。
- After（多意圖覆蓋）
  - 「我嘴巴很痛，想請幫忙評估止痛。」（痛）
  - 「我晚上睡不著，能否調整環境讓我休息？」（睡）
  - 「痛會影響我睡覺，能否先止痛再試著休息？」（痛+睡）
  - 「我想了解現在能用哪些止痛藥或舒緩方式。」（痛）

案例 D：胃管、怎麼、用、吃的（許雅雯，NGT）
- Before
  - options: 口服/普通飲食指導，與 NGT 不符。
- After（限制一致性）
  - 「我想請教鼻胃管餵食要怎麼準備？」
  - 「在家配製餵食需要注意濃度與溫度嗎？」
  - 「餵食後要避免什麼姿勢或動作？」
  - 「鼻胃管餵食若不舒服，該怎麼處理？」

案例 E：止痛、不夠、換藥、痛（口語化）
- Before
  - options: 出現專業術語（如 PCA）。
- After
  - 「我現在還是很痛，止痛藥能再調整嗎？」
  - 「藥效不太夠，能不能換一種止痛？」
  - 「我痛到睡不著，想先處理疼痛。」
  - 「我想知道還有什麼方式能讓痛減輕。」

—

**草擬變更片段（供審閱，不立即套用）**

1) 模板（audio_disfluency_template.yaml）片段建議：
```
【病患醫療背景】（用於推理，不需直接輸出）
- 場域與限制請嚴格依【角色摘要】與【近期對話】判斷；不得擅自假設住院或可下床/可口進食。

【重要原則】
1. original 必須保留關鍵詞；若輸入破碎，允許溫和重建但不得臆造新意。
2. 若偵測到多意圖（如痛、睡不著、嗆到、藥物…），options 應覆蓋不同意圖（至少各 1 句）。
3. 嚴格遵守限制：若【角色摘要】/【近期對話】提及不能說話/吞嚥/下床/口進食/鼻胃管/氣切等，選項不得違反。
4. 用語口語化：避免專業縮寫與術語；使用病人常用說法；單句、自然、禮貌。
```

2) 規則片段（build_audio_template_rules）補充：
```
請輸出單一合法 JSON，包含 'original' 與 'options'。'options' 必須為長度 {option_count} 的完整句子陣列，
且需覆蓋輸入中的不同意圖；同時嚴格服從【角色摘要】/【近期對話】的限制，避免提出違反限制的動作/請求。
```

—

**測試計畫與驗證（依專案測試規範）**
- 測試命令（範例）：
  - 啟動 API（若尚未啟動）：`docker exec dialogue-server-jiawei-dspy python /app/api_server.py`
  - 提交語音測試（UI 或 API，保持 audio.use_context=true, prompt_via_dspy=true）。
- 情境/語句用例：
  - 「嗆..到..回...家」、「回家…藥..」、「嘴、痛、睡不著」、「胃管、怎麼、用、吃的」。
- 驗證點：
  - Prompt 品質：查 `GeminiClient.last_audio_system_prompt` / `last_audio_user_prompt` 是否包含新規則。
  - 覆蓋度：4 個 options 是否涵蓋多意圖；original 是否保留關鍵詞。
  - 限制一致性：不可出現違反限制的動作（吞嚥/口服/說話/下床…）。
  - 口語風格：避免專業縮寫與流程化說明。
  - 反模板化：不得產生空泛模板句（謝謝關心…）。
- 日誌：
  - 啟用 `logging.llm_raw=true`（config 已為 true），保留 system/user prompt 與 raw/clean 輸出於 `logs/debug/`（LFS 追蹤）。

—

**風險與回滾**
- 若多意圖覆蓋導致選項偏散，可降低覆蓋要求為「至少 2 個意圖被覆蓋」。
- 若口語化過度導致資訊不足，允許在單一選項中保留 1 個較具體醫療詞，但須以病人說法呈現（例：止痛藥劑量→「藥量」）。
- 回滾：僅修改模板與規則片段，保留原始版本以便快速回退。

—

**里程碑**
- M1：模板/規則文案審核與調整（0.5d）。
- M2：小樣本用例測試（≥10 條），記錄 before/after 差異與日誌（1d）。
- M3：修正與最終提交（0.5d），撰寫 `test_results_audio_disfluency_[date].md` 與附錄 log 片段（LFS）。

