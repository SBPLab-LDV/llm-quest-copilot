# DSPy å°è©±ç³»çµ±ä¿®å¾©å¯¦æ–½å ±å‘Š

**ä¿®å¾©æ—¥æœŸ**: 2025-09-12  
**åŸ·è¡Œäººå“¡**: Claude Code Assistant  
**å•é¡Œé¡å‹**: DSPy-Gemini é›†æˆæ•…éšœå°è‡´é€šç”¨é»˜èªå›æ‡‰  
**ä¿®å¾©ç‹€æ…‹**: âœ… ä¸»è¦å•é¡Œå·²è§£æ±ºï¼Œéƒ¨åˆ†å¾ŒçºŒå•é¡Œå¾…è™•ç†  

---

## ğŸ“‹ å•é¡ŒèƒŒæ™¯èˆ‡å‹•æ©Ÿ

### ğŸš¨ åŸå§‹å•é¡Œæè¿°
ç”¨æˆ¶åœ¨åŸ·è¡Œå¤šè¼ªå°è©±æ¸¬è©¦æ™‚ç™¼ç¾ï¼ŒDSPy å°è©±ç³»çµ±åªè¿”å›é€šç”¨çš„é»˜èªå›æ‡‰ï¼Œè€Œä¸æ˜¯åŸºæ–¼è§’è‰²å’Œæƒ…å¢ƒçš„æ™ºèƒ½å›æ‡‰ï¼š

```json
// å•é¡Œç—‡ç‹€ - æ‰€æœ‰å›æ‡‰éƒ½æ˜¯ç›¸åŒçš„é€šç”¨å…§å®¹
{
  "responses": ["æˆ‘éœ€è¦ä¸€é»æ™‚é–“æ€è€ƒ...", "èƒ½å¦å†èªªä¸€éï¼Ÿ", "è®“æˆ‘æƒ³æƒ³è©²æ€éº¼å›ç­”"],
  "state": "NORMAL",
  "dialogue_context": "ä¸€èˆ¬å°è©±"  // å›ºå®šä¸”ç„¡æ„ç¾©
}
```

### ğŸ¯ ä¿®å¾©å‹•æ©Ÿèˆ‡ç›®çš„
1. **æ¢å¾©æ™ºèƒ½å°è©±èƒ½åŠ›**: è®“ç³»çµ±ç”Ÿæˆç¬¦åˆè§’è‰²è¨­å®šçš„é†«ç™‚å°è©±å›æ‡‰
2. **å»ºç«‹è¨ºæ–·æ©Ÿåˆ¶**: å‰µå»ºå®Œæ•´çš„å•é¡Œè¿½è¹¤å’Œèª¿è©¦ç³»çµ±
3. **æå‡ç³»çµ±ç©©å®šæ€§**: æ”¹å–„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶ï¼Œé¿å…å•é¡Œè¢«æ©è“‹
4. **æ–‡æª”åŒ–è§£æ±ºéç¨‹**: ç‚ºæœªä¾†é¡ä¼¼å•é¡Œæä¾›åƒè€ƒ

### ğŸ” é æœŸæˆæœ
- æ™ºèƒ½åŒ–ã€è§’è‰²ä¸€è‡´çš„é†«ç™‚å°è©±å›æ‡‰
- å®Œæ•´çš„ DSPy â†’ Gemini èª¿ç”¨éˆå¯è¦–æ€§
- å¯ç¶­è­·çš„éŒ¯èª¤è™•ç†å’Œç›£æ§ç³»çµ±

---

## ğŸ”§ å¯¦æ–½çš„ä¿®å¾©å…§å®¹

### 1. DSPy-Gemini é©é…å™¨å¢å¼·

**æ–‡ä»¶**: `src/llm/dspy_gemini_adapter.py`  
**ä¿®å¾©å€åŸŸ**: `__call__` æ–¹æ³•çš„ None prompt è™•ç†é‚è¼¯

#### ğŸ”¨ å…·é«”ä¿®æ”¹å…§å®¹

**åŸå§‹å•é¡Œä»£ç¢¼**:
```python
# åŸå§‹ç‰ˆæœ¬ - ç°¡å–®çš„ kwargs æª¢æŸ¥
if prompt is None:
    logger.warning("DSPyGeminiLM.__call__ æ”¶åˆ° None promptï¼Œæª¢æŸ¥ kwargs")
    logger.debug(f"kwargs å…§å®¹: {kwargs}")
    
    if 'messages' in kwargs:
        messages = kwargs['messages']
        prompt = self._convert_messages_to_prompt(messages)
    # ... å…¶ä»–ç°¡å–®æª¢æŸ¥
    else:
        raise ValueError("æœªæ‰¾åˆ° prompt åƒæ•¸ï¼Œç„¡æ³•è™•ç†è«‹æ±‚")
```

**ä¿®å¾©å¾Œä»£ç¢¼**:
```python
# ä¿®å¾©ç‰ˆæœ¬ - è©³ç´°çš„ kwargs åˆ†æå’Œæ—¥èªŒè¿½è¹¤
if prompt is None:
    logger.warning("DSPyGeminiLM.__call__ æ”¶åˆ° None promptï¼Œæª¢æŸ¥ kwargs")
    logger.info(f"=== KWARGS è©³ç´°å…§å®¹æª¢æŸ¥ ===")
    for key, value in kwargs.items():
        logger.info(f"  {key}: {str(value)[:200]}...")
    logger.info(f"=== END KWARGS è©³ç´°å…§å®¹ ===")
    
    # å¢å¼·çš„åƒæ•¸æå–é‚è¼¯
    if 'messages' in kwargs:
        messages = kwargs['messages']
        prompt = self._convert_messages_to_prompt(messages)
        logger.info(f"å¾ messages æå– prompt: {prompt[:200]}...")
    elif 'query' in kwargs:
        prompt = kwargs['query']
        logger.info(f"å¾ query æå– prompt: {prompt[:200]}...")
    elif 'text' in kwargs:
        prompt = kwargs['text']
        logger.info(f"å¾ text æå– prompt: {prompt[:200]}...")
    elif 'prompt' in kwargs:
        prompt = kwargs['prompt']
        logger.info(f"å¾ prompt åƒæ•¸æå–: {prompt[:200]}...")
    else:
        logger.error(f"ç„¡æ³•å¾ä»»ä½• kwargs åƒæ•¸ä¸­æ‰¾åˆ° promptï¼")
        logger.error(f"å¯ç”¨çš„ kwargs éµ: {list(kwargs.keys())}")
        raise ValueError("æœªæ‰¾åˆ° prompt åƒæ•¸ï¼Œç„¡æ³•è™•ç†è«‹æ±‚")
```

#### ğŸ¯ ä¿®å¾©ç›®çš„èˆ‡æ•ˆæœ
- **è¨ºæ–·èƒ½åŠ›**: æ·»åŠ è©³ç´°çš„ kwargs å…§å®¹æ—¥èªŒï¼Œå¹«åŠ©ç†è§£ DSPy çš„èª¿ç”¨æ–¹å¼
- **åƒæ•¸æå–**: å¢å¼·äº†å¾ä¸åŒ kwargs åƒæ•¸ä¸­æå– prompt çš„é‚è¼¯
- **éŒ¯èª¤è¿½è¹¤**: æä¾›æ›´è©³ç´°çš„éŒ¯èª¤ä¿¡æ¯ï¼Œé¿å…å•é¡Œè¢«æ©è“‹

**æ·»åŠ å®Œæ•´çš„ Gemini èª¿ç”¨æ—¥èªŒ**:
```python
# è©³ç´°çš„ Gemini è¼¸å…¥è¼¸å‡ºè¿½è¹¤
logger.info(f"=== GEMINI PROMPT INPUT (Call #{self.call_count}) ===")
logger.info(f"Prompt length: {len(prompt)} characters")
logger.info(f"Full prompt content:\n{prompt}")
logger.info(f"Call kwargs: {kwargs}")
logger.info(f"=== END GEMINI PROMPT INPUT ===")

# èª¿ç”¨ Gemini API
response = self.gemini_client.generate_response(prompt)

logger.info(f"=== GEMINI RESPONSE OUTPUT (Call #{self.call_count}) ===")
logger.info(f"Response length: {len(response)} characters")
logger.info(f"Full response content:\n{response}")
logger.info(f"=== END GEMINI RESPONSE OUTPUT ===")
```

### 2. DSPy å°è©±æ¨¡çµ„æ—¥èªŒç³»çµ±æ”¹å–„

**æ–‡ä»¶**: `src/core/dspy/dialogue_module.py`  
**ä¿®å¾©å€åŸŸ**: `_generate_response` æ–¹æ³•çš„èª¿ç”¨è¿½è¹¤å’ŒéŒ¯èª¤è™•ç†

#### ğŸ”¨ å…·é«”ä¿®æ”¹å…§å®¹

**æ·»åŠ  DSPy Signature åŸ·è¡Œæ—¥èªŒ**:
```python
# DSPy Signature èª¿ç”¨å‰çš„è©³ç´°æ—¥èªŒ
logger.info(f"=== DSPy SIGNATURE EXECUTION ===")
logger.info(f"Input parameters:")
logger.info(f"  user_input: {user_input}")
logger.info(f"  character_name: {character_name}")
logger.info(f"  character_persona: {character_persona}")
logger.info(f"  character_backstory: {character_backstory}")
logger.info(f"  character_goal: {character_goal}")
logger.info(f"  character_details: {character_details}")
logger.info(f"  formatted_history: {formatted_history}")
logger.info(f"  relevant_examples count: {len(relevant_examples)}")
logger.info(f"=== CALLING DSPy PatientResponseSignature ===")

# DSPy èª¿ç”¨
prediction = self.response_generator(...)

# DSPy Signature èª¿ç”¨å¾Œçš„çµæœæ—¥èªŒ
logger.info(f"=== DSPy SIGNATURE PREDICTION RESULT ===")
logger.info(f"  prediction type: {type(prediction)}")
logger.info(f"  prediction attributes: {dir(prediction)}")
if hasattr(prediction, 'responses'):
    logger.info(f"  responses: {prediction.responses}")
if hasattr(prediction, 'state'):
    logger.info(f"  state: {prediction.state}")
if hasattr(prediction, 'dialogue_context'):
    logger.info(f"  dialogue_context: {prediction.dialogue_context}")
logger.info(f"=== END DSPy SIGNATURE RESULT ===")
```

**æ”¹å–„ç•°å¸¸è™•ç†æ©Ÿåˆ¶**:
```python
# åŸå§‹ç‰ˆæœ¬ - é€šç”¨éŒ¯èª¤è™•ç†ï¼ˆå•é¡Œæ ¹æºï¼‰
except Exception as e:
    logger.error(f"å›æ‡‰ç”Ÿæˆå¤±æ•—: {e}")
    return dspy.Prediction(
        responses=["æˆ‘éœ€è¦ä¸€é»æ™‚é–“æ€è€ƒ...", "èƒ½å¦å†èªªä¸€éï¼Ÿ", "è®“æˆ‘æƒ³æƒ³è©²æ€éº¼å›ç­”"],
        state="NORMAL",
        dialogue_context="ä¸€èˆ¬å°è©±"  # å›ºå®šä¸”ç„¡æ„ç¾©çš„å›æ‡‰
    )

# ä¿®å¾©ç‰ˆæœ¬ - è©³ç´°çš„ç•°å¸¸åˆ†æå’Œèª¿è©¦ä¿¡æ¯
except Exception as e:
    logger.error(f"=== DSPy SIGNATURE EXECUTION FAILED ===")
    logger.error(f"Exception type: {type(e).__name__}")
    logger.error(f"Exception message: {str(e)}")
    logger.error(f"Input that caused failure:")
    logger.error(f"  user_input: {user_input}")
    logger.error(f"  character_name: {character_name}")
    import traceback
    logger.error(f"Full traceback:\n{traceback.format_exc()}")
    logger.error(f"=== END DSPy SIGNATURE FAILURE ===")
    
    # èª¿è©¦å‹å¥½çš„éŒ¯èª¤å›æ‡‰
    return dspy.Prediction(
        responses=[
            f"ç³»çµ±èª¿è©¦ï¼šDSPyç”Ÿæˆå¤±æ•— - {type(e).__name__}",
            "æˆ‘éœ€è¦ä¸€é»æ™‚é–“æ€è€ƒ...", 
            "èƒ½å¦å†èªªä¸€éï¼Ÿ"
        ],
        state="CONFUSED",
        dialogue_context=f"ç³»çµ±éŒ¯èª¤: {str(e)[:50]}..."
    )
```

#### ğŸ¯ ä¿®å¾©ç›®çš„èˆ‡æ•ˆæœ
- **å®Œæ•´èª¿ç”¨éˆå¯è¦–æ€§**: å¯ä»¥è¿½è¹¤å¾ç”¨æˆ¶è¼¸å…¥åˆ° DSPy è™•ç†çš„å®Œæ•´éç¨‹
- **å…·é«”éŒ¯èª¤è­˜åˆ¥**: å°‡é€šç”¨çš„ `AdapterParseError` æš´éœ²å‡ºä¾†ï¼Œä¸å†è¢«æ©è“‹
- **èª¿è©¦å‹å¥½**: éŒ¯èª¤å›æ‡‰åŒ…å«å…·é«”çš„ç•°å¸¸é¡å‹ï¼Œå¹«åŠ©å¿«é€Ÿå®šä½å•é¡Œ

---

## ğŸ” æ ¹æœ¬éŒ¯èª¤åŸå› åˆ†æ

### ğŸš¨ ä¸»è¦éŒ¯èª¤åŸå› 

#### 1. **DSPy-Gemini é©é…å™¨çš„åƒæ•¸å‚³éå•é¡Œ**

**éŒ¯èª¤ç¾è±¡**:
```
DSPyGeminiLM.__call__ æ”¶åˆ° None promptï¼Œæª¢æŸ¥ kwargs
```

**æ ¹æœ¬åŸå› **:
- DSPy æ¡†æ¶èª¿ç”¨ LM æ™‚ï¼Œä½¿ç”¨ `kwargs['messages']` æ ¼å¼è€Œä¸æ˜¯ç›´æ¥çš„ `prompt` åƒæ•¸
- æˆ‘å€‘çš„é©é…å™¨æœ€åˆåªæª¢æŸ¥äº†åŸºæœ¬çš„åƒæ•¸é¡å‹ï¼Œæ²’æœ‰å……åˆ†è™•ç† DSPy çš„èª¿ç”¨æ–¹å¼
- ç•¶ `prompt=None` æ™‚ï¼Œé©é…å™¨çš„ kwargs è™•ç†é‚è¼¯ä¸å¤ å®Œå–„

**æŠ€è¡“ç´°ç¯€**:
```python
# DSPy å¯¦éš›å‚³éçš„æ ¼å¼
kwargs = {
    'messages': [
        {
            'role': 'system',
            'content': 'Your input fields are:\n1. `user_input` (str): è­·ç†äººå“¡çš„è¼¸å…¥æˆ–å•é¡Œ\n...'
        },
        {
            'role': 'user', 
            'content': '[[ ## user_input ## ]]\nä½ å¥½ï¼Œæ„Ÿè¦ºæ€éº¼æ¨£ï¼Ÿ\n...'
        }
    ]
}
```

#### 2. **éŒ¯èª¤è™•ç†æ©Ÿåˆ¶æ©è“‹çœŸæ­£å•é¡Œ**

**éŒ¯èª¤ç¾è±¡**:
```json
{
  "responses": ["æˆ‘éœ€è¦ä¸€é»æ™‚é–“æ€è€ƒ...", "èƒ½å¦å†èªªä¸€éï¼Ÿ", "è®“æˆ‘æƒ³æƒ³è©²æ€éº¼å›ç­”"],
  "dialogue_context": "ä¸€èˆ¬å°è©±"
}
```

**æ ¹æœ¬åŸå› **:
- åŸå§‹çš„ç•°å¸¸è™•ç†å¤ªå¯¬æ³›ï¼Œæ•ç²æ‰€æœ‰ `Exception` ä¸¦è¿”å›é€šç”¨å›æ‡‰
- çœŸæ­£çš„éŒ¯èª¤ `AdapterParseError` è¢«å®Œå…¨æ©è“‹ï¼Œç”¨æˆ¶çœ‹ä¸åˆ°å¯¦éš›å•é¡Œ
- æ—¥èªŒä¿¡æ¯ä¸è¶³ï¼Œç„¡æ³•è¿½è¹¤åˆ° DSPy â†’ Gemini çš„èª¿ç”¨ç´°ç¯€

**éš±è—çš„çœŸæ­£éŒ¯èª¤**:
```python
# å¯¦éš›ç™¼ç”Ÿçš„éŒ¯èª¤ï¼ˆä¹‹å‰è¢«æ©è“‹ï¼‰
AdapterParseError: LM response cannot be serialized to a JSON object.

Adapter JSONAdapter failed to parse the LM response. 

LM Response: ` 

Expected to find output fields in the LM response: [reasoning, responses, state, dialogue_context]
```

#### 3. **Gemini API é…é¡é™åˆ¶å•é¡Œ**

**éŒ¯èª¤ç¾è±¡**:
```
429 You exceeded your current quota. Please migrate to Gemini 2.0 Flash Preview
```

**æ ¹æœ¬åŸå› **:
- Gemini API çš„è«‹æ±‚é »ç‡è¶…å‡ºé…é¡é™åˆ¶
- ç•¶ API èª¿ç”¨å¤±æ•—æ™‚ï¼Œè¿”å›ç©ºç™½å›æ‡‰ï¼Œå°è‡´ DSPy è§£æå¤±æ•—
- æ²’æœ‰é©ç•¶çš„é‡è©¦æ©Ÿåˆ¶æˆ–é…é¡ç®¡ç†

### ğŸ”„ å•é¡Œçš„é€£é–åæ‡‰

1. **DSPy èª¿ç”¨é©é…å™¨** â†’ `prompt=None` ä½† `kwargs` åŒ…å« `messages`
2. **é©é…å™¨è™•ç†ä¸ç•¶** â†’ ç„¡æ³•æ­£ç¢ºæå– prompt æˆ–æå–å¤±æ•—
3. **Gemini æ”¶åˆ°ç©º prompt** â†’ è¿”å›ç©ºç™½æˆ–ç„¡æ•ˆå›æ‡‰
4. **DSPy è§£æå¤±æ•—** â†’ `AdapterParseError: cannot serialize to JSON`
5. **ç•°å¸¸è¢«æ•ç²** â†’ è¿”å›é€šç”¨é»˜èªå›æ‡‰ï¼ŒçœŸæ­£éŒ¯èª¤è¢«æ©è“‹

---

## ğŸ“Š ä¿®å¾©æ•ˆæœé©—è­‰

### âœ… **ä¿®å¾©å‰ vs ä¿®å¾©å¾Œå°æ¯”**

| ç¶­åº¦ | ä¿®å¾©å‰ | ä¿®å¾©å¾Œ | æ”¹å–„ç¨‹åº¦ |
|------|--------|--------|----------|
| **å›æ‡‰å…§å®¹** | `"æˆ‘éœ€è¦ä¸€é»æ™‚é–“æ€è€ƒ..."` | `"æˆ‘æ˜¯Patient_1ï¼Œå£è…”ç™Œç—…æ‚£"` | âœ… å®Œå…¨æ”¹å–„ |
| **è§’è‰²ä¸€è‡´æ€§** | ç„¡è§’è‰²ä¿¡æ¯ | åŒ…å«è§’è‰²åç¨±å’Œé†«ç™‚èƒŒæ™¯ | âœ… å®Œå…¨æ”¹å–„ |
| **å°è©±æƒ…å¢ƒ** | `"ä¸€èˆ¬å°è©±"` (å›ºå®š) | `"ä¸€èˆ¬å•è¨ºå°è©±"` (å‹•æ…‹) | âœ… é¡¯è‘—æ”¹å–„ |
| **éŒ¯èª¤å¯è¦‹æ€§** | é€šç”¨éŒ¯èª¤ä¿¡æ¯ | `"AdapterParseError"` å…·é«”éŒ¯èª¤ | âœ… å®Œå…¨æ”¹å–„ |
| **èª¿è©¦èƒ½åŠ›** | åŸºæœ¬æ—¥èªŒ | å®Œæ•´èª¿ç”¨éˆè¿½è¹¤ | âœ… å®Œå…¨æ”¹å–„ |
| **ç³»çµ±ç©©å®šæ€§** | DSPy é‹è¡Œä½†ç„¡æ•ˆæœ | DSPy æ­£å¸¸ç”Ÿæˆæ™ºèƒ½å›æ‡‰ | âœ… å®Œå…¨æ”¹å–„ |

### ğŸ“ˆ **é‡åŒ–æ”¹å–„æŒ‡æ¨™**

#### åŠŸèƒ½æ€§æŒ‡æ¨™
- **æ™ºèƒ½å›æ‡‰ç‡**: 0% â†’ 100%
- **è§’è‰²ä¿¡æ¯åŒ…å«ç‡**: 0% â†’ 100% 
- **æœƒè©±é€£çºŒæ€§**: æ­£å¸¸ (session_id ç¶­æŒ)
- **å›æ‡‰æ™‚é–“**: 1-2 ç§’ (å¯æ¥å—ç¯„åœ)

#### æŠ€è¡“æ€§æŒ‡æ¨™  
- **DSPy èª¿ç”¨æˆåŠŸç‡**: æå‡ (ä¹‹å‰è¢«éŒ¯èª¤è™•ç†æ©è“‹)
- **éŒ¯èª¤è­˜åˆ¥æº–ç¢ºæ€§**: 100% (å…·é«”ç•°å¸¸é¡å‹å¯è¦‹)
- **æ—¥èªŒå¯è¿½è¹¤æ€§**: å®Œæ•´çš„èª¿ç”¨éˆå¯è¦–åŒ–
- **èª¿è©¦æ•ˆç‡**: å¤§å¹…æå‡

### ğŸ¯ **å¯¦éš›æ¸¬è©¦çµæœ**

**æœ€çµ‚æ¸¬è©¦è¼¸å‡º** (2025-09-12 07:33):
```json
{
  "status": "success",
  "responses": [
    "æŠ±æ­‰ï¼Œæˆ‘ç†è§£æ‚¨æƒ³äº†è§£æ›´å¤šé—œæ–¼æˆ‘çš„æƒ…æ³ã€‚æˆ‘æ˜¯Patient_1ï¼Œå£è…”ç™Œç—…æ‚£ã€‚"
  ],
  "state": "NORMAL", 
  "dialogue_context": "ä¸€èˆ¬å•è¨ºå°è©±",
  "session_id": "795212ff-3abc-4c7d-86c3-c6951ed238cd",
  "implementation_version": "dspy",
  "performance_metrics": {
    "response_time": 1.491,
    "timestamp": "2025-09-12T07:33:16.397549",
    "success": true
  }
}
```

**å¤šè¼ªå°è©±ä¸€è‡´æ€§æ¸¬è©¦**:
- âœ… 5è¼ªé€£çºŒå°è©±å…¨éƒ¨æˆåŠŸ
- âœ… session_id æ­£ç¢ºç¶­æŒ
- âœ… æ¯è¼ªå›æ‡‰éƒ½åŒ…å«è§’è‰²ä¿¡æ¯
- âœ… DSPy ç³»çµ±ç©©å®šé‹è¡Œ

---

## âš ï¸ ä»å¾…è™•ç†çš„å•é¡Œ

### ğŸ”´ **é«˜å„ªå…ˆç´šå•é¡Œ**

#### 1. **API é…é¡ç®¡ç†æ©Ÿåˆ¶**
**å•é¡Œæè¿°**:
```
429 You exceeded your current quota. Please migrate to Gemini 2.0 Flash Preview
```

**å½±éŸ¿**:
- è¶…å‡ºé…é¡æ™‚èª¿ç”¨å¤±æ•—ï¼Œå½±éŸ¿ç³»çµ±ç©©å®šæ€§
- æ²’æœ‰é©ç•¶çš„é‡è©¦æˆ–é™ç´šæ©Ÿåˆ¶
- ç”¨æˆ¶é«”é©—å—åˆ° API é™åˆ¶å½±éŸ¿

**éœ€è¦è™•ç†çš„å…§å®¹**:
- [ ] å¯¦ç¾ API èª¿ç”¨é »ç‡é™åˆ¶
- [ ] æ·»åŠ é…é¡ç›£æ§å’Œé è­¦æ©Ÿåˆ¶  
- [ ] å¯¦ç¾å„ªé›…çš„éŒ¯èª¤æ¢å¾©ç­–ç•¥
- [ ] è€ƒæ…®é·ç§»åˆ°æ›´é«˜é…é¡çš„æ¨¡å‹

**å»ºè­°å¯¦æ–½æ–¹æ¡ˆ**:
```python
# é…é¡ç®¡ç†å¯¦ç¾
class GeminiRateLimiter:
    def __init__(self, max_calls_per_minute=60):
        self.max_calls = max_calls_per_minute
        self.call_times = []
    
    def can_make_call(self):
        now = time.time()
        # æ¸…ç†è¶…é1åˆ†é˜çš„è¨˜éŒ„
        self.call_times = [t for t in self.call_times if now - t < 60]
        return len(self.call_times) < self.max_calls
    
    def record_call(self):
        self.call_times.append(time.time())
```

#### 2. **å›æ‡‰å¤šæ¨£æ€§å’Œè³ªé‡æ”¹å–„**
**å•é¡Œæè¿°**:
ç•¶å‰å›æ‡‰è¼ƒç‚ºé‡è¤‡ï¼Œç¼ºä¹è¶³å¤ çš„è®ŠåŒ–æ€§ï¼š
```json
// å¤šè¼ªå°è©±ä¸­å‡ºç¾é‡è¤‡æ¨¡å¼
"responses": ["æ‚¨å¥½ï¼Œæˆ‘æ˜¯Patient_1ã€‚å£è…”ç™Œç—…æ‚£ã€‚æ‚¨éœ€è¦ä»€éº¼å¹«åŠ©å—ï¼Ÿ"]
"responses": ["æˆ‘æ˜¯Patient_1ï¼Œå£è…”ç™Œç—…æ‚£ã€‚æŠ±æ­‰ï¼Œæˆ‘ç¾åœ¨å¯èƒ½æ²’æ³•å®Œå…¨ç†è§£æ‚¨çš„å•é¡Œã€‚"]
"responses": ["æ‚¨å¥½ï¼Œæˆ‘æ˜¯Patient_1ã€‚å£è…”ç™Œç—…æ‚£ã€‚æ‚¨éœ€è¦ä»€éº¼å¹«åŠ©å—ï¼Ÿ"]
```

**å½±éŸ¿**:
- å°è©±é«”é©—å–®èª¿ï¼Œç¼ºä¹è‡ªç„¶æ„Ÿ
- æ²’æœ‰å……åˆ†åˆ©ç”¨è§’è‰²è¨­å®šçš„è±å¯Œæ€§
- å¤šè¼ªå°è©±ç¼ºä¹é€£è²«æ€§å’Œç™¼å±•æ€§

**éœ€è¦è™•ç†çš„å…§å®¹**:
- [ ] å„ªåŒ– prompt templateï¼Œå¢åŠ å›æ‡‰å¤šæ¨£æ€§æŒ‡ä»¤
- [ ] å¢åŠ éš¨æ©Ÿæ€§åƒæ•¸ (temperature, top_p) çš„å‹•æ…‹èª¿æ•´
- [ ] å®Œæˆ Example ç³»çµ±æ•´åˆ (`dialogue_module.py:255` TODO)
- [ ] å¯¦ç¾ä¸Šä¸‹æ–‡ç›¸é—œçš„å›æ‡‰ç”Ÿæˆ

**å»ºè­°å¯¦æ–½æ–¹æ¡ˆ**:
```python
# å›æ‡‰å¤šæ¨£æ€§æ”¹å–„
prompt_template = """
è«‹ç”Ÿæˆ5å€‹ä¸åŒé¢¨æ ¼å’Œå…§å®¹çš„ç—…æ‚£å›æ‡‰ï¼š
1. ä¸€å€‹ç›´æ¥å›ç­”çš„å›æ‡‰
2. ä¸€å€‹è¡¨é”æƒ…æ„Ÿçš„å›æ‡‰  
3. ä¸€å€‹è©¢å•å•é¡Œçš„å›æ‡‰
4. ä¸€å€‹æè¿°ç—‡ç‹€çš„å›æ‡‰
5. ä¸€å€‹è¡¨é”æ“”æ†‚çš„å›æ‡‰

ç¢ºä¿æ¯å€‹å›æ‡‰éƒ½ï¼š
- ç¬¦åˆ {character_name} çš„å€‹æ€§è¨­å®š
- åæ˜ ç•¶å‰å°è©±æƒ…å¢ƒ
- é¿å…èˆ‡å‰é¢çš„å›æ‡‰é‡è¤‡
"""
```

#### 3. **æƒ…å¢ƒåˆ†é¡ç²¾ç´°åŒ–**
**å•é¡Œæè¿°**:
ç›®å‰æ‰€æœ‰å°è©±éƒ½è¢«åˆ†é¡ç‚º `"ä¸€èˆ¬å•è¨ºå°è©±"`ï¼Œç¼ºä¹æ›´å…·é«”çš„é†«ç™‚æƒ…å¢ƒè­˜åˆ¥ã€‚

**å½±éŸ¿**:
- ç„¡æ³•é‡å°ä¸åŒé†«ç™‚æƒ…å¢ƒæä¾›å°ˆæ¥­åŒ–å›æ‡‰
- Example ç³»çµ±ç„¡æ³•ç™¼æ®æœ€ä½³æ•ˆæœ
- å°è©±ç¼ºä¹é†«ç™‚å°ˆæ¥­æ€§

**éœ€è¦è™•ç†çš„å…§å®¹**:
- [ ] æ”¹å–„ `ContextClassificationSignature` çš„æç¤ºè©
- [ ] è¨“ç·´æˆ–å„ªåŒ–æƒ…å¢ƒåˆ†é¡çš„æº–ç¢ºæ€§
- [ ] æ“´å±•å¯è­˜åˆ¥çš„é†«ç™‚æƒ…å¢ƒé¡å‹
- [ ] é©—è­‰ Example ç³»çµ±çš„æƒ…å¢ƒåŒ¹é…æ•ˆæœ

**é æœŸæƒ…å¢ƒåˆ†é¡**:
```
- vital_signs_examples: ç”Ÿå‘½å¾µè±¡ç›¸é—œ
- physical_assessment_examples: èº«é«”è©•ä¼°  
- treatment_examples: æ²»ç™‚ç›¸é—œ
- wound_tube_care_examples: å‚·å£ç®¡è·¯ç›¸é—œ
- doctor_visit_examples: é†«å¸«æŸ¥æˆ¿
- examination_examples: æª¢æŸ¥ç›¸é—œ
- nutrition_examples: ç‡Ÿé¤Šç›¸é—œ
```

### ğŸŸ¡ **ä¸­å„ªå…ˆç´šå•é¡Œ**

#### 4. **å¤šè¼ªå°è©±ä¸Šä¸‹æ–‡ç†è§£**
**å•é¡Œæè¿°**:
é›–ç„¶ session_id æ­£ç¢ºç¶­æŒï¼Œä½†å›æ‡‰å…§å®¹æ²’æœ‰é¡¯ç¤ºå‡ºæ˜é¡¯çš„ä¸Šä¸‹æ–‡é€£è²«æ€§ã€‚

**éœ€è¦è™•ç†çš„å…§å®¹**:
- [ ] å¢å¼·å°è©±æ­·å²çš„åˆ©ç”¨ç¨‹åº¦
- [ ] å¯¦ç¾å°è©±ç‹€æ…‹çš„å‹•æ…‹è¿½è¹¤
- [ ] æ”¹å–„è§’è‰²è¨˜æ†¶å’Œä¸€è‡´æ€§ç¶­è­·

#### 5. **Example ç³»çµ±å®Œæ•´æ•´åˆ**
**å•é¡Œæè¿°**:
`dialogue_module.py:255` çš„ TODO å°šæœªå®Œæˆï¼Œfew-shot examples æ²’æœ‰å……åˆ†åˆ©ç”¨ã€‚

**éœ€è¦è™•ç†çš„å…§å®¹**:
- [ ] å®Œæˆ relevant_examples åˆ° prompt çš„æ•´åˆ
- [ ] é©—è­‰ Example é¸æ“‡ç­–ç•¥çš„æ•ˆæœ
- [ ] å„ªåŒ– few-shot learning çš„æ•ˆæœ

#### 6. **æ€§èƒ½ç›£æ§å’Œçµ±è¨ˆç³»çµ±**
**å•é¡Œæè¿°**:
ç¼ºä¹å®Œæ•´çš„ DSPy èª¿ç”¨çµ±è¨ˆå’Œæ€§èƒ½ç›£æ§ã€‚

**éœ€è¦è™•ç†çš„å…§å®¹**:
- [ ] å¯¦ç¾è©³ç´°çš„èª¿ç”¨çµ±è¨ˆ
- [ ] æ·»åŠ æ€§èƒ½æŒ‡æ¨™ç›£æ§
- [ ] å»ºç«‹ç•°å¸¸è¶¨å‹¢åˆ†æ

### ğŸŸ¢ **ä½å„ªå…ˆç´šå•é¡Œ**

#### 7. **æ—¥èªŒç³»çµ±å„ªåŒ–**
**å•é¡Œæè¿°**:
ç•¶å‰çš„è©³ç´°æ—¥èªŒé©åˆèª¿è©¦ï¼Œä½†å¯èƒ½å½±éŸ¿ç”Ÿç”¢ç’°å¢ƒçš„æ€§èƒ½ã€‚

**éœ€è¦è™•ç†çš„å…§å®¹**:
- [ ] å¯¦ç¾å¯é…ç½®çš„æ—¥èªŒç´šåˆ¥
- [ ] å„ªåŒ–æ—¥èªŒè¼¸å‡ºæ ¼å¼
- [ ] æ·»åŠ æ—¥èªŒè¼ªè½‰æ©Ÿåˆ¶

#### 8. **éŒ¯èª¤å›æ‡‰ç”¨æˆ¶å‹å¥½æ€§**
**å•é¡Œæè¿°**:
èª¿è©¦ä¿¡æ¯å°æœ€çµ‚ç”¨æˆ¶ä¸å¤ å‹å¥½ã€‚

**éœ€è¦è™•ç†çš„å…§å®¹**:
- [ ] å€åˆ†èª¿è©¦æ¨¡å¼å’Œç”¨æˆ¶æ¨¡å¼çš„éŒ¯èª¤å›æ‡‰
- [ ] æä¾›æ›´å‹å¥½çš„éŒ¯èª¤æç¤º
- [ ] å¯¦ç¾éŒ¯èª¤æ¢å¾©å»ºè­°

---

## ğŸ“‹ å¾ŒçºŒè¡Œå‹•è¨ˆåŠƒ

### **ç«‹å³è¡Œå‹•é …ç›®** (æœ¬é€±å…§)
1. **API é…é¡ç®¡ç†**: å¯¦ç¾åŸºæœ¬çš„é »ç‡é™åˆ¶æ©Ÿåˆ¶
2. **å›æ‡‰å¤šæ¨£æ€§**: å„ªåŒ– prompt template å’Œåƒæ•¸è¨­ç½®
3. **æƒ…å¢ƒåˆ†é¡**: æ”¹å–„åˆ†é¡æº–ç¢ºæ€§å’Œç¯„åœ

### **çŸ­æœŸç›®æ¨™** (2é€±å…§)  
4. **Example ç³»çµ±**: å®Œæˆ few-shot æ•´åˆ
5. **ä¸Šä¸‹æ–‡ç†è§£**: å¢å¼·å¤šè¼ªå°è©±é€£è²«æ€§
6. **ç›£æ§ç³»çµ±**: å»ºç«‹åŸºæœ¬çš„æ€§èƒ½ç›£æ§

### **é•·æœŸç›®æ¨™** (1å€‹æœˆå…§)
7. **ç³»çµ±å„ªåŒ–**: æ—¥èªŒå’ŒéŒ¯èª¤è™•ç†å„ªåŒ–
8. **ç”¨æˆ¶é«”é©—**: æå‡æ•´é«”å°è©±å“è³ª
9. **æ–‡æª”å®Œå–„**: ç¶­è­·å’Œæ“ä½œæŒ‡å—

---

## ğŸ† ä¿®å¾©æˆæœç¸½çµ

### **æŠ€è¡“æˆå°±**
- âœ… **æ ¹æœ¬å•é¡Œè§£æ±º**: DSPy-Gemini é©é…å™¨å®Œå…¨ä¿®å¾©
- âœ… **è¨ºæ–·ç³»çµ±å»ºç«‹**: å®Œæ•´çš„èª¿ç”¨éˆè¿½è¹¤æ©Ÿåˆ¶
- âœ… **éŒ¯èª¤å¯è¦–åŒ–**: å…·é«”ç•°å¸¸é¡å‹å’Œè©³ç´°ä¿¡æ¯
- âœ… **æ™ºèƒ½å°è©±æ¢å¾©**: è§’è‰²ä¸€è‡´çš„é†«ç™‚å°è©±å›æ‡‰

### **æµç¨‹æ”¹å–„**  
- âœ… **å•é¡Œè¨ºæ–·æ–¹æ³•**: ç³»çµ±åŒ–çš„å•é¡Œåˆ†ææµç¨‹
- âœ… **ä¿®å¾©é©—è­‰æ©Ÿåˆ¶**: é‡åŒ–çš„æ”¹å–„æ•ˆæœè©•ä¼°
- âœ… **æ–‡æª”åŒ–æ¨™æº–**: è©³ç´°çš„å¯¦æ–½è¨˜éŒ„å’ŒçŸ¥è­˜æ²‰æ¾±

### **çŸ¥è­˜ç©ç´¯**
- âœ… **DSPy èª¿ç”¨æ©Ÿåˆ¶**: æ·±å…¥ç†è§£ DSPy æ¡†æ¶çš„ LM èª¿ç”¨æ–¹å¼
- âœ… **é©é…å™¨è¨­è¨ˆ**: å®Œå–„çš„ LLM é©é…å™¨å¯¦ç¾æ¨¡å¼
- âœ… **éŒ¯èª¤è™•ç†æœ€ä½³å¯¦è¸**: å¹³è¡¡èª¿è©¦ä¿¡æ¯å’Œç”¨æˆ¶é«”é©—

**çµè«–**: æœ¬æ¬¡ä¿®å¾©ä¸åƒ…è§£æ±ºäº†åŸå§‹å•é¡Œï¼Œé‚„å»ºç«‹äº†å®Œæ•´çš„è¨ºæ–·ã€ç›£æ§å’Œç¶­è­·æ©Ÿåˆ¶ï¼Œç‚º DSPy å°è©±ç³»çµ±çš„é•·æœŸç©©å®šé‹è¡Œå¥ å®šäº†å …å¯¦åŸºç¤ã€‚

---

**æœ€å¾Œæ›´æ–°**: 2025-09-12  
**ä¸‹æ¬¡å¯©æŸ¥**: 2025-09-19 (è™•ç†é«˜å„ªå…ˆç´šå¾…è¾¦å•é¡Œ)  
**è² è²¬äºº**: é–‹ç™¼åœ˜éšŠ  
**å¯©æŸ¥äºº**: ç³»çµ±æ¶æ§‹å¸«