# DSPy Example 架構設計文檔

## 目錄
1. [架構概述](#架構概述)
2. [設計理念與動機](#設計理念與動機)
3. [核心組件詳解](#核心組件詳解)
4. [架構圖示](#架構圖示)
5. [設計決策與權衡](#設計決策與權衡)
6. [實際應用案例](#實際應用案例)
7. [未來擴展考量](#未來擴展考量)

---

## 架構概述

DSPy Example 系統是一個三層式架構，專門設計用於管理、檢索和智能選擇對話範例，為 DSPy 框架提供高效的 few-shot learning 支援。

### 核心價值主張
- **智能範例管理**：自動化範例的載入、驗證和索引
- **高效檢索系統**：基於嵌入向量和多策略的範例檢索
- **自適應選擇**：根據歷史表現動態調整選擇策略
- **可擴展架構**：易於添加新的檢索策略和範例來源

---

## 設計理念與動機

### 1. 為什麼需要 Example 系統？

在 DSPy 框架中，few-shot learning 是提升模型表現的關鍵技術。然而，管理大量範例並選擇最相關的範例是一個複雜的挑戰：

```
問題空間：
┌─────────────────────────────────────────┐
│          挑戰與需求分析                 │
├─────────────────────────────────────────┤
│ 1. 範例數量龐大 (數百到數千個)          │
│ 2. 多種情境需要不同的範例              │
│ 3. 需要快速檢索相關範例                │
│ 4. 範例品質影響模型表現                │
│ 5. 需要動態調整選擇策略                │
└─────────────────────────────────────────┘
           ↓
    設計 Example 系統解決
```

### 2. 設計原則

#### 2.1 關注點分離 (Separation of Concerns)
```
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│   載入層     │   │   儲存層     │   │   選擇層     │
│              │   │              │   │              │
│ 負責:        │   │ 負責:        │   │ 負責:        │
│ • 格式轉換   │   │ • 索引管理   │   │ • 策略執行   │
│ • 驗證       │   │ • 嵌入計算   │   │ • 歷史追蹤   │
│ • 解析       │   │ • 快取       │   │ • 自適應     │
└──────────────┘   └──────────────┘   └──────────────┘
```

#### 2.2 性能優先
- 使用嵌入向量預計算
- 實施多層快取機制
- 支援批量操作

#### 2.3 容錯設計
- Graceful degradation（優雅降級）
- 多重 fallback 機制
- 完整的錯誤處理

---

## 核心組件詳解

### 1. ExampleLoader（範例載入器）

**設計動機**：將外部資料格式（YAML）轉換為內部表示（DSPy Example）

```
╔════════════════════════════════════════════════════════════════════╗
║                        ExampleLoader 設計詳解                      ║
╠════════════════════════════════════════════════════════════════════╣
║                                                                    ║
║  設計考量：                                                        ║
║  1. 為什麼選擇 YAML 格式？                                        ║
║     • 人類可讀性高                                                ║
║     • 支援複雜結構                                                ║
║     • 易於版本控制                                                ║
║                                                                    ║
║  2. 轉換流程設計：                                                 ║
║                                                                    ║
║     YAML File                                                     ║
║         ↓                                                          ║
║     [Parsing]                                                      ║
║         ↓                                                          ║
║     Raw Data ──→ [Validation] ──→ [Transformation]                ║
║                        ↓                  ↓                        ║
║                    [Error Log]      DSPy Example                  ║
║                                                                    ║
║  3. 驗證機制：                                                     ║
║     • 結構驗證：確保必要欄位存在                                  ║
║     • 類型驗證：確保資料類型正確                                  ║
║     • 邏輯驗證：確保狀態值合法                                    ║
║                                                                    ║
║  4. 批量處理優化：                                                 ║
║     • 使用生成器模式減少記憶體使用                                ║
║     • 支援並行載入多個檔案                                        ║
║     • 錯誤隔離（單個錯誤不影響整體）                              ║
║                                                                    ║
╚════════════════════════════════════════════════════════════════════╝
```

**關鍵設計決策**：

1. **延遲載入 vs 預載入**
   - 選擇：預載入所有範例
   - 原因：對話系統需要快速響應，預載入可避免運行時延遲

2. **驗證時機**
   - 選擇：載入時立即驗證
   - 原因：早期發現問題，避免運行時錯誤

### 2. ExampleBank（範例銀行）

**設計動機**：集中管理所有範例，提供高效的儲存和基礎檢索功能

```
╔════════════════════════════════════════════════════════════════════╗
║                        ExampleBank 架構設計                        ║
╠════════════════════════════════════════════════════════════════════╣
║                                                                    ║
║  核心資料結構：                                                    ║
║                                                                    ║
║  ┌─────────────────────────────────────────────────┐              ║
║  │            ExampleBank 內部結構                  │              ║
║  │                                                  │              ║
║  │  examples: Dict[str, List[Example]]              │              ║
║  │     ├── "vital_signs": [ex1, ex2, ...]          │              ║
║  │     ├── "wound_care": [ex3, ex4, ...]           │              ║
║  │     └── "exercise": [ex5, ex6, ...]             │              ║
║  │                                                  │              ║
║  │  all_examples: List[Example]                     │              ║
║  │     [ex1, ex2, ex3, ex4, ex5, ex6, ...]         │              ║
║  │                                                  │              ║
║  │  context_index: Dict[str, List[int]]            │              ║
║  │     ├── "vital_signs": [0, 1]                   │              ║
║  │     ├── "wound_care": [2, 3]                    │              ║
║  │     └── "exercise": [4, 5]                      │              ║
║  │                                                  │              ║
║  │  embeddings: np.ndarray                         │              ║
║  │     [[0.1, 0.2, ...],  # ex1 embedding          │              ║
║  │      [0.3, 0.4, ...],  # ex2 embedding          │              ║
║  │      ...]                                       │              ║
║  └─────────────────────────────────────────────────┘              ║
║                                                                    ║
║  設計理由：                                                        ║
║  1. 雙重索引系統：                                                 ║
║     • 按情境索引：快速獲取特定情境範例                            ║
║     • 平面列表：便於全域搜索和批量操作                            ║
║                                                                    ║
║  2. 嵌入向量管理：                                                 ║
║     • 預計算：避免實時計算延遲                                    ║
║     • 快取機制：持久化儲存，減少重複計算                          ║
║     • Fallback：支援簡單文本相似度作為備選                        ║
║                                                                    ║
╚════════════════════════════════════════════════════════════════════╝
```

**嵌入向量系統設計**：

```
┌─────────────────────────────────────────────────────────┐
│              嵌入向量計算與快取流程                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  需要嵌入向量                                           │
│       ↓                                                 │
│  檢查快取檔案                                           │
│       ↓                                                 │
│  ┌─────────┐  Yes   ┌──────────────┐                  │
│  │ 存在？  │───────→│ 載入快取     │                  │
│  └─────────┘        └──────────────┘                  │
│       │ No                   │                         │
│       ↓                      ↓                         │
│  檢查模型可用性         返回嵌入向量                    │
│       ↓                                                │
│  ┌─────────────┐  No   ┌──────────────────┐          │
│  │ 可用？      │──────→│ 使用簡單相似度  │          │
│  └─────────────┘       └──────────────────┘          │
│       │ Yes                                           │
│       ↓                                                │
│  計算嵌入向量                                          │
│       ↓                                                │
│  儲存到快取                                            │
│       ↓                                                │
│  返回嵌入向量                                          │
│                                                        │
└─────────────────────────────────────────────────────────┘
```

### 3. ExampleSelector（範例選擇器）

**設計動機**：提供智能的範例選擇策略，支援多種檢索方法和自適應調整

```
╔════════════════════════════════════════════════════════════════════╗
║                    ExampleSelector 策略設計                        ║
╠════════════════════════════════════════════════════════════════════╣
║                                                                    ║
║  策略層次架構：                                                    ║
║                                                                    ║
║  ┌──────────────────────────────────────────┐                    ║
║  │          高層策略 (Meta-Strategy)         │                    ║
║  │                                           │                    ║
║  │  • Adaptive: 根據歷史動態調整             │                    ║
║  │  • Hybrid: 組合多種基礎策略               │                    ║
║  │  • Balanced: 確保跨情境平衡               │                    ║
║  └─────────────────┬─────────────────────────┘                    ║
║                    │                                              ║
║  ┌─────────────────▼─────────────────────────┐                    ║
║  │          基礎策略 (Base Strategy)         │                    ║
║  │                                           │                    ║
║  │  • Random: 隨機選擇（基線）               │                    ║
║  │  • Context: 基於情境匹配                  │                    ║
║  │  • Similarity: 基於向量相似度             │                    ║
║  │  • Keyword: 基於關鍵字匹配                │                    ║
║  └───────────────────────────────────────────┘                    ║
║                                                                    ║
║  自適應機制設計：                                                  ║
║                                                                    ║
║     歷史表現追蹤                                                   ║
║         ↓                                                          ║
║     計算成功率                                                     ║
║         ↓                                                          ║
║     ┌───────────┐                                                 ║
║     │ > 80%?    │──Yes──→ 保持當前策略                            ║
║     └───────────┘                                                 ║
║         │ No                                                       ║
║         ↓                                                          ║
║     ┌───────────┐                                                 ║
║     │ > 60%?    │──Yes──→ 微調權重                                ║
║     └───────────┘         (±0.1)                                  ║
║         │ No                                                       ║
║         ↓                                                          ║
║     大幅調整權重                                                   ║
║     (±0.2)                                                        ║
║                                                                    ║
╚════════════════════════════════════════════════════════════════════╝
```

**策略選擇決策樹**：

```
                     使用者查詢
                         │
                         ▼
                ┌──────────────────┐
                │ 有指定策略？      │
                └────────┬─────────┘
                   Yes  │  │ No
                        │  │
           ┌────────────┘  └───────────┐
           ▼                           ▼
    使用指定策略                 ┌──────────────────┐
                                │ 有情境資訊？      │
                                └────────┬─────────┘
                                   Yes  │  │ No
                                        │  │
                          ┌─────────────┘  └──────────┐
                          ▼                           ▼
                   ┌──────────────────┐        ┌──────────────────┐
                   │ 歷史表現良好？    │        │ 使用相似度策略    │
                   └────────┬─────────┘        └──────────────────┘
                      Yes  │  │ No
                           │  │
             ┌─────────────┘  └──────────┐
             ▼                           ▼
      使用混合策略                  使用自適應策略
```

---

## 架構圖示

### 完整系統架構圖

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        DSPy Example System Architecture                       │
│                              完整系統架構圖                                   │
└──────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────────┐
│                              Layer 1: Data Layer                              │
│                                 資料層                                        │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐                │
│  │ YAML Files     │  │ Cache Files    │  │ Config Files   │                │
│  │                │  │                │  │                │                │
│  │ • Examples     │  │ • Embeddings   │  │ • DSPy Config  │                │
│  │ • Contexts     │  │ • Indices      │  │ • Model Config │                │
│  │ • Metadata     │  │ • Statistics   │  │ • Strategy     │                │
│  └────────────────┘  └────────────────┘  └────────────────┘                │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                          Layer 2: Processing Layer                            │
│                                處理層                                         │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────┐        │
│  │                         ExampleLoader                            │        │
│  │                                                                  │        │
│  │  • load_yaml_file()      : 載入 YAML 檔案                      │        │
│  │  • yaml_to_dspy_examples(): 格式轉換                           │        │
│  │  • validate_example()    : 驗證範例完整性                      │        │
│  │  • load_all_examples()   : 批量載入                            │        │
│  └──────────────────────────────────────────────────────────────────┘        │
│                                   │                                          │
│                                   ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────┐        │
│  │                         ExampleBank                              │        │
│  │                                                                  │        │
│  │  Data Structures:                                                │        │
│  │  ┌──────────────────────────────────────────────────────┐       │        │
│  │  │ • examples: Dict[context, List[Example]]            │       │        │
│  │  │ • all_examples: List[Example]                       │       │        │
│  │  │ • context_index: Dict[context, List[idx]]          │       │        │
│  │  │ • embeddings: np.ndarray                            │       │        │
│  │  └──────────────────────────────────────────────────────┘       │        │
│  │                                                                  │        │
│  │  Methods:                                                        │        │
│  │  • compute_embeddings()   : 計算嵌入向量                        │        │
│  │  • get_relevant_examples(): 基礎檢索                            │        │
│  │  • add_example()         : 動態添加範例                         │        │
│  └──────────────────────────────────────────────────────────────────┘        │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                         Layer 3: Intelligence Layer                           │
│                                智能層                                         │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────┐        │
│  │                       ExampleSelector                            │        │
│  │                                                                  │        │
│  │  Strategies:                                                     │        │
│  │  ┌──────────────────────────────────────────────────────┐       │        │
│  │  │ • random     : 隨機選擇                              │       │        │
│  │  │ • context    : 情境匹配                              │       │        │
│  │  │ • similarity : 向量相似度                            │       │        │
│  │  │ • keyword    : 關鍵字匹配                            │       │        │
│  │  │ • hybrid     : 混合策略                              │       │        │
│  │  │ • adaptive   : 自適應策略                            │       │        │
│  │  │ • balanced   : 平衡策略                              │       │        │
│  │  └──────────────────────────────────────────────────────┘       │        │
│  │                                                                  │        │
│  │  Adaptive System:                                                │        │
│  │  • selection_history : 追蹤選擇歷史                             │        │
│  │  • performance_metrics: 性能指標                                │        │
│  │  • adaptive_weights  : 動態權重調整                             │        │
│  └──────────────────────────────────────────────────────────────────┘        │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                         Layer 4: Application Layer                            │
│                                應用層                                         │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐             │
│  │ DialogueModule  │  │ Optimizer       │  │ DialogueManager │             │
│  │                 │  │                 │  │                 │             │
│  │ Uses examples   │  │ Uses examples   │  │ Uses examples   │             │
│  │ for few-shot    │  │ for training    │  │ for responses   │             │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘             │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 資料流程圖

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                            Example Data Flow                                  │
│                              範例資料流程                                      │
└──────────────────────────────────────────────────────────────────────────────┘

   啟動時載入流程：
   ================

   [YAML Files]
        │
        ▼
   ExampleLoader.load_yaml_file()
        │
        ├──→ [Validation] ──→ [Error Log]
        │
        ▼
   ExampleLoader.yaml_to_dspy_examples()
        │
        ▼
   [DSPy Examples]
        │
        ▼
   ExampleBank.load_all_examples()
        │
        ├──→ Build indices
        ├──→ Create context_index
        └──→ Flatten to all_examples
        
   運行時檢索流程：
   ================

   [User Query]
        │
        ▼
   ExampleSelector.select_examples()
        │
        ├──→ Strategy Selection
        │         │
        │         ├──→ random_selection()
        │         ├──→ context_based_selection()
        │         ├──→ similarity_based_selection()
        │         ├──→ keyword_based_selection()
        │         ├──→ hybrid_selection()
        │         ├──→ adaptive_selection()
        │         └──→ balanced_selection()
        │
        ▼
   ExampleBank.get_relevant_examples()
        │
        ├──→ Check embeddings availability
        │         │
        │         ├──→ Use vector similarity
        │         └──→ Fallback to text similarity
        │
        ▼
   Diversity Check
        │
        ▼
   [Selected Examples]
        │
        ▼
   Update History & Metrics
        │
        ▼
   Return to Application
```

---

## 設計決策與權衡

### 1. 嵌入向量 vs 文本相似度

**決策**：優先使用嵌入向量，提供文本相似度作為 fallback

**權衡分析**：
```
┌────────────────────────────────────────────────────────┐
│                    比較分析                             │
├────────────────────────────────────────────────────────┤
│                                                        │
│  嵌入向量方法：                                        │
│  ✓ 優點：                                              │
│    • 語義理解更準確                                    │
│    • 支援跨語言相似度                                  │
│    • 可捕捉深層語義關係                                │
│  ✗ 缺點：                                              │
│    • 需要額外依賴（sentence-transformers）             │
│    • 計算成本較高                                      │
│    • 需要儲存空間                                      │
│                                                        │
│  文本相似度方法：                                      │
│  ✓ 優點：                                              │
│    • 無外部依賴                                        │
│    • 計算快速                                          │
│    • 實現簡單                                          │
│  ✗ 缺點：                                              │
│    • 只能捕捉表面相似                                  │
│    • 對同義詞處理較差                                  │
│                                                        │
│  設計選擇：混合方案                                    │
│  • 預設使用嵌入向量                                    │
│  • 自動檢測可用性                                      │
│  • 無縫切換到文本相似度                                │
│                                                        │
└────────────────────────────────────────────────────────┘
```

### 2. 預載入 vs 延遲載入

**決策**：採用預載入策略

**理由**：
```
場景分析：
┌──────────────────────────────────────┐
│ 對話系統特性：                        │
│ • 需要快速響應（< 100ms）             │
│ • 範例集合相對固定                    │
│ • 記憶體使用可接受（< 1GB）           │
│                                      │
│ 結論：預載入更適合                    │
└──────────────────────────────────────┘
```

### 3. 策略選擇機制

**決策**：提供多種策略，支援自動選擇

```
策略決策矩陣：
┌─────────────────┬────────────┬────────────┬────────────┐
│     場景        │  最佳策略   │  備選策略   │   原因     │
├─────────────────┼────────────┼────────────┼────────────┤
│ 明確情境        │  Context   │  Hybrid    │ 情境匹配高 │
│ 開放問題        │  Similarity│  Adaptive  │ 語義相關   │
│ 關鍵字明確      │  Keyword   │  Hybrid    │ 精確匹配   │
│ 無明確線索      │  Adaptive  │  Random    │ 歷史學習   │
│ 需要多樣性      │  Balanced  │  Hybrid    │ 避免偏差   │
└─────────────────┴────────────┴────────────┴────────────┘
```

---

## 實際應用案例

### 案例 1：生命徵象詢問

```
使用者輸入："你發燒了嗎？"

處理流程：
1. ExampleSelector 接收查詢
2. 識別可能的情境："vital_signs"
3. 選擇 hybrid 策略
4. ExampleBank 執行檢索：
   - 50% 從 vital_signs 情境
   - 50% 基於相似度
5. 返回 5 個最相關範例
6. DialogueModule 使用範例生成回應

結果範例：
[
  {"user_input": "你體溫多少？", "responses": ["37.8度"]},
  {"user_input": "有發燒嗎？", "responses": ["有點熱熱的"]},
  {"user_input": "量過體溫嗎？", "responses": ["剛量是38度"]},
  ...
]
```

### 案例 2：自適應調整

```
系統運行一段時間後：

初始權重：
- context_weight: 0.4
- similarity_weight: 0.6

經過 100 次選擇後：
- 成功率: 75%
- 調整後權重：
  - context_weight: 0.3
  - similarity_weight: 0.7

原因：相似度策略在該場景表現更好
```

---

## 未來擴展考量

### 1. 短期改進（1-3 個月）

```
┌──────────────────────────────────────────────────┐
│              短期改進計劃                         │
├──────────────────────────────────────────────────┤
│                                                  │
│ 1. 性能優化                                      │
│    • 實施 LRU 快取                               │
│    • 並行嵌入計算                                │
│    • 索引優化                                    │
│                                                  │
│ 2. 功能增強                                      │
│    • 支援動態範例更新                            │
│    • 添加範例品質評分                            │
│    • 實施 A/B 測試框架                           │
│                                                  │
│ 3. 監控改進                                      │
│    • 詳細的性能指標                              │
│    • 範例使用熱圖                                │
│    • 策略效果分析                                │
│                                                  │
└──────────────────────────────────────────────────┘
```

### 2. 長期願景（6-12 個月）

```
┌──────────────────────────────────────────────────┐
│              長期發展路線圖                       │
├──────────────────────────────────────────────────┤
│                                                  │
│ 1. 機器學習增強                                  │
│    • 訓練專用的範例選擇模型                      │
│    • 強化學習優化策略                            │
│    • 自動範例生成                                │
│                                                  │
│ 2. 分散式架構                                    │
│    • 範例儲存分散化                              │
│    • 跨節點同步                                  │
│    • 邊緣快取                                    │
│                                                  │
│ 3. 多模態支援                                    │
│    • 圖像範例                                    │
│    • 音頻範例                                    │
│    • 混合模態檢索                                │
│                                                  │
└──────────────────────────────────────────────────┘
```

### 3. 擴展點設計

```
擴展介面設計：

┌──────────────────────────────────────────────────┐
│           可擴展介面 (Extension Points)          │
├──────────────────────────────────────────────────┤
│                                                  │
│ 1. Strategy Interface                           │
│    class BaseStrategy(ABC):                     │
│        @abstractmethod                          │
│        def select(query, context, k): pass      │
│                                                  │
│ 2. Embedding Interface                          │
│    class BaseEmbedding(ABC):                    │
│        @abstractmethod                          │
│        def encode(texts): pass                  │
│                                                  │
│ 3. Storage Interface                            │
│    class BaseStorage(ABC):                      │
│        @abstractmethod                          │
│        def store(examples): pass                │
│        @abstractmethod                          │
│        def retrieve(query): pass                │
│                                                  │
└──────────────────────────────────────────────────┘
```

---

## 結論

DSPy Example 架構通過三層分離的設計，實現了高效、智能且可擴展的範例管理系統。其核心優勢在於：

1. **模組化設計**：各組件職責明確，易於維護和擴展
2. **性能優化**：多層快取和預計算確保快速響應
3. **智能選擇**：多種策略和自適應機制提供最佳範例
4. **容錯能力**：完善的 fallback 機制確保系統穩定性
5. **可觀察性**：詳細的指標和歷史追蹤支援持續優化

這個架構不僅滿足了當前的需求，還為未來的擴展預留了充分的空間，是一個經過深思熟慮的設計方案。