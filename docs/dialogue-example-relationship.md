# DSPy Dialogue 系統與 Example 關係詳解

## 目錄
1. [系統架構概覽](#系統架構概覽)
2. [Dialogue 組件分析](#dialogue-組件分析)
3. [多輪對話機制](#多輪對話機制)
4. [與 Example 系統的整合](#與-example-系統的整合)
5. [對話流程圖解](#對話流程圖解)
6. [多輪對話能力評估](#多輪對話能力評估)
7. [技術實現細節](#技術實現細節)
8. [實際應用案例](#實際應用案例)
9. [限制與改進建議](#限制與改進建議)

---

## 系統架構概覽

DSPy 系統中的 dialogue 組件採用分層架構，支援多輪對話並與 Example 系統深度整合：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        DSPy Dialogue 系統架構概覽                           │
└─────────────────────────────────────────────────────────────────────────────┘

                            使用者 (護理人員)
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                             API 層                                           │
│  • FastAPI 端點 (/api/dialogue/text)                                       │
│  • 請求驗證與格式化                                                         │
│  • 回應序列化                                                               │
└────────────────────────┬─────────────────────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                          管理層 (Manager Layer)                              │
│                                                                              │
│  ┌─────────────────────┐              ┌──────────────────────┐              │
│  │   DialogueManager   │    繼承      │ DialogueManagerDSPy  │              │
│  │   (原始實現)        │   ◄─────     │   (DSPy 增強版)     │              │
│  │                     │              │                      │              │
│  │ • 基本對話邏輯      │              │ • DSPy 整合          │              │
│  │ • 歷史管理          │              │ • Example 系統       │              │
│  │ • 狀態追蹤          │              │ • 智能回退          │              │
│  │ • 日誌記錄          │              │ • 統計監控          │              │
│  └─────────────────────┘              └──────────────────────┘              │
└────────────────────────┬─────────────────────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                         核心層 (Core Layer)                                  │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │                    DSPyDialogueModule                           │        │
│  │                                                                 │        │
│  │  DSPy 子模組：                                                  │        │
│  │  ┌────────────────┐  ┌────────────────┐  ┌──────────────────┐  │        │
│  │  │ Context        │  │ Response       │  │ State           │  │        │
│  │  │ Classifier     │  │ Generator      │  │ Transition      │  │        │
│  │  │                │  │                │  │                 │  │        │
│  │  │ 情境分類        │  │ 回應生成        │  │ 狀態管理        │  │        │
│  │  └────────────────┘  └────────────────┘  └──────────────────┘  │        │
│  │                                                                 │        │
│  │  ┌────────────────┐  ┌────────────────┐  ┌──────────────────┐  │        │
│  │  │ Response       │  │ Dialogue       │  │ Example         │  │        │
│  │  │ Evaluator      │  │ Consistency    │  │ Selector        │  │        │
│  │  │                │  │                │  │                 │  │        │
│  │  │ 品質評估        │  │ 一致性檢查      │  │ 範例選擇        │  │        │
│  │  └────────────────┘  └────────────────┘  └──────────────────┘  │        │
│  └─────────────────────────────────────────────────────────────────┘        │
└────────────────────────┬─────────────────────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                        Example 支援層                                        │
│                                                                              │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐          │
│  │ ExampleSelector  │  │   ExampleBank    │  │  ExampleLoader   │          │
│  │                  │  │                  │  │                  │          │
│  │ • 智能選擇       │  │ • 儲存管理       │  │ • YAML 載入      │          │
│  │ • 多種策略       │  │ • 索引建立       │  │ • 格式轉換       │          │
│  │ • 自適應調整     │  │ • 嵌入計算       │  │ • 驗證檢查       │          │
│  └──────────────────┘  └──────────────────┘  └──────────────────┘          │
└──────────────────────────────────────────────────────────────────────────────┘

                                數據流向
                            ════════════════
                         Example 提供 Few-shot
                         Signature 定義格式
                         History 維持上下文
```

---

## Dialogue 組件分析

### 1. 核心組件關係圖

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                          Dialogue 核心組件詳解                               ║
╠══════════════════════════════════════════════════════════════════════════════╣
║                                                                              ║
║  1. DialogueManagerDSPy (對話管理器)                                        ║
║  ┌─────────────────────────────────────────────────────────────────┐        ║
║  │                                                                   │        ║
║  │  職責：                                                          │        ║
║  │  • 繼承原始 DialogueManager 的完整介面                          │        ║
║  │  • 整合 DSPy 框架進行智能對話處理                                │        ║
║  │  • 提供 fallback 機制確保系統穩定性                             │        ║
║  │  • 管理對話歷史與狀態轉換                                        │        ║
║  │                                                                   │        ║
║  │  關鍵特性：                                                      │        ║
║  │  ┌─────────────────────────────────────────────────────┐        │        ║
║  │  │ conversation_history = []                           │        │        ║
║  │  │ • 儲存完整對話記錄                                  │        │        ║
║  │  │ • 支援多輪對話上下文                                │        │        ║
║  │  │ • 自動格式化：限制最近5輪                           │        │        ║
║  │  └─────────────────────────────────────────────────────┘        │        ║
║  │                                                                   │        ║
║  │  ┌─────────────────────────────────────────────────────┐        │        ║
║  │  │ async def process_turn(user_input, ...)             │        │        ║
║  │  │ • 處理單輪對話                                      │        │        ║
║  │  │ • 呼叫 DSPyDialogueModule                           │        │        ║
║  │  │ • 更新歷史和狀態                                    │        │        ║
║  │  └─────────────────────────────────────────────────────┘        │        ║
║  └─────────────────────────────────────────────────────────────────┘        ║
║                                                                              ║
║  2. DSPyDialogueModule (DSPy 對話模組)                                      ║
║  ┌─────────────────────────────────────────────────────────────────┐        ║
║  │                                                                   │        ║
║  │  職責：                                                          │        ║
║  │  • 實現 DSPy Module 介面                                        │        ║
║  │  • 整合多個 Signature 進行複合推理                              │        ║
║  │  • 與 Example 系統協同工作                                      │        ║
║  │  • 提供智能的情境分類和回應生成                                  │        ║
║  │                                                                   │        ║
║  │  核心流程：                                                      │        ║
║  │  ┌─────────────────────────────────────────────────────┐        │        ║
║  │  │ def forward(user_input, character_*, conversation_  │        │        ║
║  │  │           history, ...):                            │        │        ║
║  │  │                                                     │        │        ║
║  │  │   1. 情境分類 (ContextClassificationSignature)     │        │        ║
║  │  │      ↓                                              │        │        ║
║  │  │   2. 範例選擇 (ExampleSelector)                     │        │        ║
║  │  │      ↓                                              │        │        ║
║  │  │   3. 回應生成 (PatientResponseSignature)           │        │        ║
║  │  │      ↓                                              │        │        ║
║  │  │   4. 品質評估 (ResponseEvaluationSignature)        │        │        ║
║  │  │      ↓                                              │        │        ║
║  │  │   5. 一致性檢查 (DialogueConsistencySignature)     │        │        ║
║  │  └─────────────────────────────────────────────────────┘        │        ║
║  └─────────────────────────────────────────────────────────────────┘        ║
║                                                                              ║
║  3. 與 Example 系統的整合點                                                 ║
║  ┌─────────────────────────────────────────────────────────────────┐        ║
║  │                                                                   │        ║
║  │  • ExampleSelector 提供情境相關的範例                           │        ║
║  │  • 範例用於 PatientResponseSignature 的 few-shot learning      │        ║
║  │  • conversation_history 作為 Signature 輸入欄位               │        ║
║  │  • 歷史對話影響範例選擇策略                                      │        ║
║  │                                                                   │        ║
║  │  整合邏輯：                                                      │        ║
║  │  ┌─────────────────────────────────────────────────────┐        │        ║
║  │  │ context = classify_context(user_input, history)     │        │        ║
║  │  │ examples = selector.select_examples(                │        │        ║
║  │  │     query=user_input,                               │        │        ║
║  │  │     context=context,                                │        │        ║
║  │  │     strategy="hybrid"                               │        │        ║
║  │  │ )                                                   │        │        ║
║  │  │ response = generate_response(                       │        │        ║
║  │  │     user_input=user_input,                          │        │        ║
║  │  │     conversation_history=formatted_history,         │        │        ║
║  │  │     examples=examples  # few-shot learning         │        │        ║
║  │  │ )                                                   │        │        ║
║  │  └─────────────────────────────────────────────────────┘        │        ║
║  └─────────────────────────────────────────────────────────────────┘        ║
║                                                                              ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

---

## 多輪對話機制

### 1. 多輪對話的實現架構

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          多輪對話實現機制詳解                               │
└─────────────────────────────────────────────────────────────────────────────┘

對話歷史管理：
================

class DialogueManager:
    def __init__(self):
        self.conversation_history = []  # 核心：對話歷史列表
        
    def _format_conversation_history(self) -> List[str]:
        return self.conversation_history[-5:]  # 保留最近5輪
        
    async def process_turn(self, user_input: str):
        # 1. 記錄用戶輸入
        self.conversation_history.append(f"護理人員: {user_input}")
        
        # 2. 處理對話（使用歷史上下文）
        response = await self._process_with_history()
        
        # 3. 記錄系統回應
        self.conversation_history.append(f"{self.character.name}: {selected_response}")

歷史格式範例：
=============
conversation_history = [
    "護理人員: 你好，感覺怎麼樣？",
    "王大明: 還可以，就是有點累",
    "護理人員: 有發燒嗎？",
    "王大明: 好像有一點",
    "護理人員: 體溫多少度？"  # ← 當前輪次
]


多輪對話流程圖：
================

輪次 1                    輪次 2                    輪次 N
────────                  ────────                  ────────

[用戶輸入 1]             [用戶輸入 2]              [用戶輸入 N]
     │                        │                         │
     ▼                        ▼                         ▼
[記錄到歷史]             [記錄到歷史]              [記錄到歷史]
     │                        │                         │
     ▼                        ▼                         ▼
[情境分類]               [情境分類]                [情境分類]
• 輸入：current           • 輸入：current           • 輸入：current
• 歷史：[]                • 歷史：[輪次1]           • 歷史：[輪次1...N-1]
     │                        │                         │
     ▼                        ▼                         ▼
[範例選擇]               [範例選擇]                [範例選擇]
• 考慮對話脈絡           • 考慮對話脈絡             • 考慮對話脈絡
• 選擇相關範例           • 選擇相關範例             • 選擇相關範例
     │                        │                         │
     ▼                        ▼                         ▼
[回應生成]               [回應生成]                [回應生成]
• few-shot學習           • few-shot學習             • few-shot學習
• 歷史上下文增強         • 歷史上下文增強           • 歷史上下文增強
     │                        │                         │
     ▼                        ▼                         ▼
[更新歷史]               [更新歷史]                [更新歷史]
     │                        │                         │
     ▼                        ▼                         ▼
[輸出回應]               [輸出回應]                [輸出回應]


上下文增強機制：
================

┌─────────────────────────────────────────────────────────────────┐
│                    上下文如何影響對話                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  情境一：初次見面                                               │
│  ─────────────────                                              │
│  輪次1: 護理人員: "你好"                                        │
│  系統分析: 無歷史 → 選擇通用問候範例                           │
│  回應: "你好，我是王大明"                                       │
│                                                                 │
│  情境二：延續對話                                               │
│  ─────────────────                                              │
│  輪次2: 護理人員: "感覺怎麼樣？"                                │
│  系統分析: 有問候歷史 → 選擇健康狀況相關範例                   │
│  回應: "還可以，就是有點不舒服"                                 │
│                                                                 │
│  情境三：深入詢問                                               │
│  ─────────────────                                              │
│  輪次3: 護理人員: "哪裡不舒服？"                                │
│  系統分析: 有不適症狀歷史 → 選擇症狀描述範例                   │
│  回應: "肚子有點痛，還有點想吐"                                 │
│                                                                 │
│  情境四：專業詢問                                               │
│  ─────────────────                                              │
│  輪次4: 護理人員: "痛了多久？"                                  │
│  系統分析: 有症狀歷史 → 選擇時間描述範例                       │
│  回應: "從昨天晚上開始的"                                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2. 歷史管理的技術實現

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                            歷史管理技術細節                                   ║
╠══════════════════════════════════════════════════════════════════════════════╣
║                                                                              ║
║  1. 歷史儲存結構                                                            ║
║  ┌─────────────────────────────────────────────────────────────────┐        ║
║  │                                                                   │        ║
║  │  conversation_history: List[str]                                 │        ║
║  │                                                                   │        ║
║  │  格式：                                                          │        ║
║  │  • "護理人員: {user_input}"                                      │        ║
║  │  • "{character_name}: {selected_response}"                      │        ║
║  │  • "(跳過此輪回應)"                                              │        ║
║  │                                                                   │        ║
║  │  範例：                                                          │        ║
║  │  [                                                               │        ║
║  │    "護理人員: 你好，感覺怎麼樣？",                                │        ║
║  │    "王大明: 還可以，就是有點累",                                  │        ║
║  │    "護理人員: 有發燒嗎？",                                        │        ║
║  │    "王大明: 好像有一點",                                          │        ║
║  │    "護理人員: 體溫多少度？"                                       │        ║
║  │  ]                                                               │        ║
║  └─────────────────────────────────────────────────────────────────┘        ║
║                                                                              ║
║  2. 歷史格式化邏輯                                                          ║
║  ┌─────────────────────────────────────────────────────────────────┐        ║
║  │                                                                   │        ║
║  │  def _format_conversation_history(self) -> List[str]:            │        ║
║  │      return self.conversation_history[-5:]                       │        ║
║  │                                                                   │        ║
║  │  用於 Signature 的格式化：                                       │        ║
║  │  formatted_history = "\n".join(conversation_history[-5:])        │        ║
║  │                                                                   │        ║
║  │  傳遞給 DSPy：                                                   │        ║
║  │  prediction = self.response_generator(                           │        ║
║  │      user_input=user_input,                                      │        ║
║  │      conversation_history=formatted_history,  # 字符串格式       │        ║
║  │      ...                                                         │        ║
║  │  )                                                               │        ║
║  └─────────────────────────────────────────────────────────────────┘        ║
║                                                                              ║
║  3. 歷史長度限制與記憶體管理                                                ║
║  ┌─────────────────────────────────────────────────────────────────┐        ║
║  │                                                                   │        ║
║  │  設計考量：                                                      │        ║
║  │  • 限制：最近 5 輪對話                                           │        ║
║  │  • 原因：避免 context window 溢出                               │        ║
║  │  • 平衡：足夠上下文 vs. 處理效率                                │        ║
║  │                                                                   │        ║
║  │  實現方式：                                                      │        ║
║  │  • 完整歷史：conversation_history（持續增長）                   │        ║
║  │  • 處理歷史：[-5:]（動態窗口）                                   │        ║
║  │  • 日誌歷史：interaction_log（完整記錄）                        │        ║
║  │                                                                   │        ║
║  │  記憶體優化：                                                    │        ║
║  │  • 可考慮實施 LRU 快取                                           │        ║
║  │  • 可考慮歷史壓縮（摘要）                                        │        ║
║  │  • 可考慮分階段記憶（短期/長期）                                 │        ║
║  └─────────────────────────────────────────────────────────────────┘        ║
║                                                                              ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

---

## 與 Example 系統的整合

### 1. 整合架構圖

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Dialogue 與 Example 系統整合架構                         │
└─────────────────────────────────────────────────────────────────────────────┘

                              單輪對話處理流程
                         ═══════════════════════════

[用戶輸入] + [對話歷史]
           │
           ▼
┌──────────────────────┐
│  情境分類階段         │
│                      │
│ ContextClassification│
│ Signature            │
│                      │
│ 輸入：               │
│ • user_input         │
│ • conversation_hist. │ ◄── 歷史上下文影響分類
│                      │
│ 輸出：               │
│ • context="vital_s"  │
│ • confidence=0.9     │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│  範例選擇階段         │
│                      │
│ ExampleSelector      │
│                      │
│ 策略選擇：           │
│ • 基於情境 (50%)     │
│ • 基於相似度 (50%)   │ ◄── 利用分類結果
│                      │
│ 考慮因素：           │
│ • 當前用戶輸入       │
│ • 歷史對話脈絡       │ ◄── 歷史影響範例選擇
│ • 角色一致性         │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│  回應生成階段         │
│                      │
│ PatientResponse      │
│ Signature            │
│                      │
│ Few-shot輸入：       │
│ • selected_examples  │ ◄── Example 系統提供
│                      │
│ Context輸入：        │
│ • user_input         │
│ • character_info     │
│ • conversation_hist. │ ◄── 完整上下文
│                      │
│ 輸出：               │
│ • responses=[5個]    │
│ • state="NORMAL"     │
│ • context="vital_s"  │
└──────────┬───────────┘
           │
           ▼
[更新對話歷史] ──→ [下一輪循環]


整合的關鍵連接點：
==================

┌─────────────────────────────────────────────────────────────────┐
│                         關鍵整合點                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 歷史 → 情境分類                                             │
│  ─────────────────────                                          │
│  def _classify_context(user_input, conversation_history):      │
│      return self.context_classifier(                           │
│          user_input=user_input,                                │
│          conversation_history="\n".join(history[-5:])          │
│      )                                                         │
│                                                                 │
│  2. 情境 + 歷史 → 範例選擇                                      │
│  ──────────────────────────                                   │
│  examples = self.example_selector.select_examples(             │
│      query=user_input,                                         │
│      context=context_prediction.context,                       │
│      k=5,                                                      │
│      strategy="hybrid"                                         │
│  )                                                             │
│                                                                 │
│  3. 範例 + 歷史 → 回應生成                                      │
│  ──────────────────────────                                   │
│  response = self.response_generator(                           │
│      user_input=user_input,                                    │
│      conversation_history=formatted_history,                   │
│      # DSPy 自動使用 examples 進行 few-shot                    │
│  )                                                             │
│                                                                 │
│  4. 回應 → 歷史更新                                             │
│  ─────────────────────                                         │
│  self.conversation_history.append(                             │
│      f"{character.name}: {selected_response}"                  │
│  )                                                             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2. Example 對多輪對話的影響

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                      Example 如何增強多輪對話能力                            ║
╠══════════════════════════════════════════════════════════════════════════════╣
║                                                                              ║
║  1. 上下文感知的範例選擇                                                    ║
║  ┌─────────────────────────────────────────────────────────────────┐        ║
║  │                                                                   │        ║
║  │  對話輪次 1：                                                    │        ║
║  │  護理人員: "你好"                                                │        ║
║  │  → 選擇問候相關範例                                              │        ║
║  │                                                                   │        ║
║  │  對話輪次 2：                                                    │        ║
║  │  護理人員: "感覺怎麼樣？"                                        │        ║
║  │  → 基於"問候"歷史，選擇健康狀況範例                             │        ║
║  │                                                                   │        ║
║  │  對話輪次 3：                                                    │        ║
║  │  護理人員: "有發燒嗎？"                                          │        ║
║  │  → 基於"健康詢問"歷史，選擇症狀相關範例                         │        ║
║  │                                                                   │        ║
║  │  範例選擇策略會根據歷史脈絡動態調整：                           │        ║
║  │  • 初始：使用通用範例                                           │        ║
║  │  • 深入：選擇更具體的專業範例                                   │        ║
║  │  • 持續：保持主題一致性                                         │        ║
║  └─────────────────────────────────────────────────────────────────┘        ║
║                                                                              ║
║  2. 歷史一致性檢查                                                          ║
║  ┌─────────────────────────────────────────────────────────────────┐        ║
║  │                                                                   │        ║
║  │  DialogueConsistencySignature 使用：                            │        ║
║  │  • 完整對話歷史                                                 │        ║
║  │  • 角色設定資訊                                                 │        ║
║  │  • 當前提議回應                                                 │        ║
║  │                                                                   │        ║
║  │  檢查項目：                                                     │        ║
║  │  • 回應是否與先前陳述矛盾                                       │        ║
║  │  • 角色行為是否一致                                             │        ║
║  │  • 邏輯連貫性                                                   │        ║
║  │                                                                   │        ║
║  │  範例：                                                         │        ║
║  │  輪次1: "我沒有發燒"                                            │        ║
║  │  輪次3: "體溫38.5度" ← 不一致，會被標記                       │        ║
║  └─────────────────────────────────────────────────────────────────┘        ║
║                                                                              ║
║  3. 自適應學習機制                                                          ║
║  ┌─────────────────────────────────────────────────────────────────┐        ║
║  │                                                                   │        ║
║  │  ExampleSelector 會根據多輪對話的表現調整：                     │        ║
║  │                                                                   │        ║
║  │  • 追蹤每輪選擇的範例效果                                       │        ║
║  │  • 分析歷史脈絡對選擇準確性的影響                               │        ║
║  │  • 動態調整 context_weight 和 similarity_weight                │        ║
║  │                                                                   │        ║
║  │  學習循環：                                                     │        ║
║  │  對話進行 → 範例選擇 → 回應生成 → 品質評估 →                   │        ║
║  │  ↑                                              ↓                │        ║
║  │  策略調整 ← 性能分析 ← 歷史追蹤 ← 效果記錄                     │        ║
║  └─────────────────────────────────────────────────────────────────┘        ║
║                                                                              ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

---

## 對話流程圖解

### 1. 完整多輪對話流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          完整多輪對話流程圖解                               │
└─────────────────────────────────────────────────────────────────────────────┘

                            系統啟動
                                │
                                ▼
                    ┌──────────────────────┐
                    │  初始化階段          │
                    │                      │
                    │ • 載入角色設定       │
                    │ • 初始化 DSPy        │
                    │ • 載入 Example 系統  │
                    │ • conversation_hist  │
                    │   ory = []           │
                    └──────────┬───────────┘
                               │
                    ┌─────────▼─────────┐
                    │                   │
                ┌───┴───┐           ┌───▼───┐
                │ 輪次1 │           │ 輪次N │
                └───────┘           └───────┘

═══════════════════════════════════════════════════════════════════════════════
                              單輪處理詳細流程
═══════════════════════════════════════════════════════════════════════════════

    [護理人員輸入]
           │
           ▼
    ┌──────────────────┐
    │ 1. 記錄用戶輸入  │
    │                  │
    │ conversation_    │
    │ history.append(  │
    │   f"護理人員:     │
    │   {user_input}"  │
    │ )                │
    └─────────┬────────┘
              │
              ▼
    ┌──────────────────┐
    │ 2. 歷史格式化    │
    │                  │
    │ formatted_hist = │
    │ "\n".join(       │
    │   history[-5:]   │
    │ )                │
    └─────────┬────────┘
              │
              ▼
    ┌──────────────────┐
    │ 3. 情境分類      │
    │                  │
    │ context =        │
    │ classifier(      │
    │   user_input,    │
    │   formatted_hist │
    │ )                │
    └─────────┬────────┘
              │
              ▼
    ┌──────────────────┐
    │ 4. 範例選擇      │
    │                  │
    │ examples =       │
    │ selector.select( │
    │   query=input,   │
    │   context=context│
    │ )                │
    └─────────┬────────┘
              │
              ▼
    ┌──────────────────┐
    │ 5. 回應生成      │
    │                  │
    │ response =       │
    │ generator(       │
    │   user_input,    │
    │   history,       │
    │   examples       │
    │ )                │
    └─────────┬────────┘
              │
              ▼
    ┌──────────────────┐
    │ 6. 品質評估      │
    │                  │
    │ evaluation =     │
    │ evaluator(       │
    │   response       │
    │ )                │
    └─────────┬────────┘
              │
              ▼
    ┌──────────────────┐
    │ 7. 一致性檢查    │
    │                  │
    │ consistency =    │
    │ checker(         │
    │   history,       │
    │   response       │
    │ )                │
    └─────────┬────────┘
              │
              ▼
    ┌──────────────────┐
    │ 8. 用戶選擇      │
    │                  │
    │ selected_resp =  │
    │ user_choice(     │
    │   responses      │
    │ )                │
    └─────────┬────────┘
              │
              ▼
    ┌──────────────────┐
    │ 9. 更新歷史      │
    │                  │
    │ conversation_    │
    │ history.append(  │
    │   f"{char_name}: │
    │   {selected}"    │
    │ )                │
    └─────────┬────────┘
              │
              ▼
    ┌──────────────────┐
    │ 10. 記錄互動     │
    │                  │
    │ log_interaction( │
    │   user_input,    │
    │   responses,     │
    │   selected       │
    │ )                │
    └─────────┬────────┘
              │
              ▼
       [等待下輪輸入]


歷史如何影響每個階段：
======================

階段 3 (情境分類):
└── 歷史幫助理解對話主題脈絡

階段 4 (範例選擇):
└── 根據歷史選擇更相關的範例
    • 初次見面 → 問候範例
    • 症狀詢問 → 醫療範例
    • 深入討論 → 專業範例

階段 5 (回應生成):
└── 歷史作為 context，確保回應連貫

階段 7 (一致性檢查):
└── 檢查當前回應與歷史是否矛盾
```

---

## 多輪對話能力評估

### 1. 當前系統的多輪對話能力

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                          多輪對話能力分析                                    ║
╠══════════════════════════════════════════════════════════════════════════════╣
║                                                                              ║
║  ✅ 已具備的多輪對話能力                                                   ║
║  ┌─────────────────────────────────────────────────────────────────┐        ║
║  │                                                                   │        ║
║  │  1. 基本多輪支援                                                │        ║
║  │  ──────────────────                                             │        ║
║  │  • conversation_history 列表維護完整對話記錄                   │        ║
║  │  • 自動記錄用戶輸入和系統回應                                  │        ║
║  │  • 支援無限輪次對話（理論上）                                  │        ║
║  │  • 持久化日誌記錄到檔案                                        │        ║
║  │                                                                   │        ║
║  │  2. 上下文感知                                                  │        ║
║  │  ──────────────                                                 │        ║
║  │  • 最近5輪對話作為處理上下文                                   │        ║
║  │  • 歷史影響情境分類準確性                                      │        ║
║  │  • 基於歷史的範例選擇優化                                      │        ║
║  │  • 對話脈絡追蹤與主題連貫性                                    │        ║
║  │                                                                   │        ║
║  │  3. 智能回應生成                                                │        ║
║  │  ──────────────────                                             │        ║
║  │  • Few-shot learning 基於歷史上下文                            │        ║
║  │  • 角色一致性維護                                              │        ║
║  │  • 狀態感知的回應調整                                          │        ║
║  │  • 多個回應選項供用戶選擇                                      │        ║
║  │                                                                   │        ║
║  │  4. 品質保證機制                                                │        ║
║  │  ──────────────────                                             │        ║
║  │  • 回應品質評估                                                │        ║
║  │  • 對話一致性檢查                                              │        ║
║  │  • 歷史矛盾偵測                                                │        ║
║  │  • 自適應策略調整                                              │        ║
║  └─────────────────────────────────────────────────────────────────┘        ║
║                                                                              ║
║  ⚠️  限制與不足                                                            ║
║  ┌─────────────────────────────────────────────────────────────────┐        ║
║  │                                                                   │        ║
║  │  1. 記憶窗口限制                                                │        ║
║  │  ──────────────────                                             │        ║
║  │  • 只使用最近5輪對話（硬編碼限制）                             │        ║
║  │  • 無長期記憶機制                                              │        ║
║  │  • 早期重要資訊可能遺失                                        │        ║
║  │                                                                   │        ║
║  │  2. 狀態管理簡單                                                │        ║
║  │  ──────────────────                                             │        ║
║  │  • 只有基本的對話狀態（NORMAL, CONFUSED, etc.）                │        ║
║  │  • 缺乏複雜的對話流程控制                                      │        ║
║  │  • 無分支對話或條件跳轉                                        │        ║
║  │                                                                   │        ║
║  │  3. 個人化程度有限                                              │        ║
║  │  ──────────────────────                                         │        ║
║  │  • 無用戶偏好學習                                              │        ║
║  │  • 缺乏個人化的對話風格調整                                    │        ║
║  │  • 角色行為相對固定                                            │        ║
║  │                                                                   │        ║
║  │  4. 複雜推理能力                                                │        ║
║  │  ──────────────────                                             │        ║
║  │  • 基於範例的模式匹配為主                                      │        ║
║  │  • 缺乏複雜的因果推理                                          │        ║
║  │  • 對複雜醫療場景的處理有限                                    │        ║
║  └─────────────────────────────────────────────────────────────────┘        ║
║                                                                              ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

### 2. 多輪對話品質評估

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            多輪對話品質評估矩陣                              │
└─────────────────────────────────────────────────────────────────────────────┘

評估維度                    當前水準    滿分    說明
═══════════════════════════════════════════════════════════════════════════════

1. 上下文連貫性             4/5         5      ✓ 能維持5輪內的連貫性
                                               ⚠ 超出5輪可能失去脈絡

2. 角色一致性               4/5         5      ✓ 角色設定維護良好
                                               ⚠ 長對話中可能出現偏差

3. 回應相關性               4/5         5      ✓ Example系統提供相關範例
                                               ⚠ 依賴範例庫品質

4. 對話自然度               3/5         5      ✓ 基於真實範例，較自然
                                               ⚠ 某些場景可能生硬

5. 錯誤恢復能力             4/5         5      ✓ 有fallback機制
                                               ⚠ 錯誤處理可再改進

6. 學習適應能力             3/5         5      ✓ 有自適應機制
                                               ⚠ 學習速度較慢

7. 複雜場景處理             2/5         5      ⚠ 主要基於模式匹配
                                               ❌ 缺乏深度推理

8. 個人化程度               2/5         5      ⚠ 基本角色個人化
                                               ❌ 無動態偏好調整

═══════════════════════════════════════════════════════════════════════════════
總體評分: 26/40 (65%) - 良好，但有改進空間
═══════════════════════════════════════════════════════════════════════════════

強項：
• 基礎多輪功能完整
• 上下文感知良好
• Example系統增強效果明顯
• 品質保證機制完善

弱項：
• 記憶窗口限制
• 複雜推理不足
• 個人化程度有限
• 長對話品質下降
```

---

## 技術實現細節

### 1. 關鍵程式碼解析

```python
# 核心多輪對話實現 (dialogue_manager_dspy.py:70-135)
# ================================================================

async def process_turn(self, user_input: str, gui_selected_response: Optional[str] = None):
    """
    多輪對話的核心處理函數
    每一輪對話都會調用此函數
    """
    self.stats['total_calls'] += 1  # 統計追蹤
    
    # ===== 第1步：記錄用戶輸入到對話歷史 =====
    self.conversation_history.append(f"護理人員: {user_input}")
    
    # ===== 第2步：使用DSPy模組處理輸入 =====
    prediction = self.dialogue_module(
        user_input=user_input,
        character_name=self.character.name,
        character_persona=self.character.persona,
        character_backstory=self.character.backstory,
        character_goal=self.character.goal,
        character_details=self._get_character_details(),
        conversation_history=self._format_conversation_history()  # 關鍵：傳遞歷史
    )
    
    # ===== 第3步：處理回應並更新歷史 =====
    response_data = self._process_dspy_prediction(prediction)
    
    # ===== 第4步：評估回應品質 =====
    evaluation = self.evaluator.evaluate_prediction(user_input, prediction)
    
    # ===== 第5步：更新對話狀態 =====
    self._update_dialogue_state(response_data)
    
    # ===== 第6步：處理用戶選擇並更新歷史 =====
    if selected_response:
        self.conversation_history.append(f"{self.character.name}: {selected_response}")
    
    return response_data


# DSPy模組的多輪處理邏輯 (dialogue_module.py:95-270)
# ===========================================================

def forward(self, user_input: str, character_name: str, character_persona: str,
           character_backstory: str, character_goal: str, character_details: str,
           conversation_history: List[str]) -> dspy.Prediction:
    """
    DSPy模組的前向傳播，整合歷史上下文
    """
    # ===== 步驟1：情境分類（考慮歷史） =====
    context_prediction = self._classify_context(
        user_input, 
        conversation_history  # 歷史影響分類
    )
    
    # ===== 步驟2：範例選擇（基於情境和歷史） =====
    relevant_examples = self.example_selector.select_examples(
        query=user_input,
        context=context_prediction.context,
        k=5,
        strategy="hybrid"
    )
    
    # ===== 步驟3：回應生成（包含歷史上下文） =====
    response_prediction = self._generate_response(
        user_input=user_input,
        character_name=character_name,
        character_persona=character_persona,
        character_backstory=character_backstory,
        character_goal=character_goal,
        character_details=character_details,
        conversation_history=conversation_history,  # 完整歷史傳遞
        relevant_examples=relevant_examples
    )
    
    return response_prediction

def _classify_context(self, user_input: str, conversation_history: List[str]):
    """
    情境分類：歷史上下文如何影響分類
    """
    # 格式化歷史（只使用最近5輪）
    formatted_history = "\n".join(conversation_history[-5:])
    
    # 調用分類簽名，歷史作為輸入
    return self.context_classifier(
        user_input=user_input,
        available_contexts=self._get_available_contexts(),
        conversation_history=formatted_history  # 歷史影響分類決策
    )

def _generate_response(self, user_input: str, character_name: str,
                      character_persona: str, character_backstory: str,
                      character_goal: str, character_details: str,
                      conversation_history: List[str],
                      relevant_examples: List[dspy.Example]):
    """
    回應生成：整合歷史、角色、範例
    """
    # 格式化歷史
    formatted_history = "\n".join(conversation_history[-5:])
    
    # 配置few-shot範例
    with dspy.context(lm=self.lm):
        if relevant_examples:
            # 使用選中的範例進行few-shot learning
            dspy.settings.configure(examples=relevant_examples)
        
        # 生成回應，歷史作為重要輸入
        return self.response_generator(
            user_input=user_input,
            character_name=character_name,
            character_persona=character_persona,
            character_backstory=character_backstory,
            character_goal=character_goal,
            character_details=character_details,
            conversation_history=formatted_history  # 歷史確保連貫性
        )


# 歷史格式化的核心邏輯 (dialogue.py:45-51)
# ================================================

def _format_conversation_history(self) -> List[str]:
    """
    格式化對話歷史，限制上下文窗口
    """
    return self.conversation_history[-5:]  # 只保留最近5輪
    
# 為什麼選擇5輪？
# 1. 平衡上下文豐富度與處理效率
# 2. 避免超出LLM的context window限制
# 3. 對於醫療對話，5輪通常足以捕捉當前話題
# 4. 可配置化：未來可以根據需要調整


# 多輪狀態管理 (dialogue_manager_dspy.py:194-207)
# ===================================================

def _update_dialogue_state(self, response_data: Dict[str, Any]):
    """
    根據回應更新對話狀態
    狀態會影響下一輪的處理邏輯
    """
    try:
        new_state = response_data.get("state", "NORMAL")
        self.current_state = DialogueState(new_state)
        
        # 狀態轉換會影響：
        # 1. 下一輪的範例選擇策略
        # 2. 回應生成的參數
        # 3. 錯誤恢復的行為
        
        dialogue_context = response_data.get("dialogue_context", "")
        if dialogue_context:
            print(f"DSPy 判斷的對話情境: {dialogue_context}")
            # 情境會影響範例選擇
            
    except ValueError:
        self.logger.warning(f"Invalid state: {new_state}, setting to CONFUSED")
        self.current_state = DialogueState.CONFUSED
```

---

## 實際應用案例

### 案例：完整多輪醫療對話流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        實際多輪對話案例分析                                 │
└─────────────────────────────────────────────────────────────────────────────┘

場景設定：
=========
角色：王大明，68歲男性，因肺炎住院
護理人員：進行日常健康檢查

對話流程：
==========

【輪次 1】初次接觸
──────────────────
護理人員: "王爺爺早安，今天感覺怎麼樣？"

系統處理：
• 歷史: [] (空)
• 情境分類: "一般問候" (confidence: 0.95)
• 範例選擇: 問候相關範例 (strategy: context)
  - 選中: "你好，我是..." 類型範例
• 回應生成: 基於few-shot，考慮角色(老年男性)

王大明回應選項：
1. "早安護士小姐，還不錯啦"
2. "你好，我是王大明"
3. "早，感覺還可以"
4. "護士好，今天精神比較好"
5. "早安，謝謝你的關心"

用戶選擇：選項1 "早安護士小姐，還不錯啦"

歷史更新：
conversation_history = [
    "護理人員: 王爺爺早安，今天感覺怎麼樣？",
    "王大明: 早安護士小姐，還不錯啦"
]


【輪次 2】深入詢問
──────────────────
護理人員: "有沒有覺得發燒或不舒服？"

系統處理：
• 歷史: ["護理人員: ...", "王大明: 早安護士小姐，還不錯啦"]
• 情境分類: "生命徵象相關" (confidence: 0.92)
  - 歷史影響：從"一般問候"轉向"健康狀況"
• 範例選擇: vital_signs相關範例 (strategy: hybrid)
  - 基於歷史脈絡，選擇"感覺還不錯"後的健康詢問範例
• 回應生成: 考慮肺炎背景，可能有症狀

王大明回應選項：
1. "有一點點不舒服"
2. "好像有點熱熱的"
3. "咳嗽還是有的"
4. "胸部有點悶"
5. "應該沒有發燒吧"

用戶選擇：選項2 "好像有點熱熱的"

歷史更新：
conversation_history = [
    "護理人員: 王爺爺早安，今天感覺怎麼樣？",
    "王大明: 早安護士小姐，還不錯啦",
    "護理人員: 有沒有覺得發燒或不舒服？",
    "王大明: 好像有點熱熱的"
]


【輪次 3】專業評估
──────────────────
護理人員: "那我幫您量個體溫好嗎？"

系統處理：
• 歷史: [前面4條記錄]
• 情境分類: "生命徵象測量" (confidence: 0.98)
  - 歷史強化：從"感覺熱"自然過渡到"測量體溫"
• 範例選擇: 體溫測量相關範例
  - 考慮患者已表達"熱"的感受
• 一致性檢查: ✓ 與"有點熱熱的"一致
• 回應生成: 合作配合醫療程序

王大明回應選項：
1. "好的，麻煩妳了"
2. "可以啊，應該要量一下"
3. "嗯，量量看吧"
4. "好，我配合"
5. "謝謝護士，辛苦了"

用戶選擇：選項1 "好的，麻煩妳了"


【輪次 4】結果確認
──────────────────
護理人員: "體溫37.8度，確實有點發燒呢"

系統處理：
• 歷史: [前面6條記錄]
• 情境分類: "檢查結果告知" (confidence: 0.96)
• 範例選擇: 檢查結果回應範例
• 一致性檢查: ✓ 與之前"熱熱的"感受一致
• 回應生成: 對檢查結果的反應

王大明回應選項：
1. "難怪覺得有點熱"
2. "是有一點燒"
3. "還好不是很高"
4. "需要吃藥嗎？"
5. "那要怎麼辦？"

【輪次 5】後續處置
──────────────────
護理人員: "我先記錄下來，等醫師查房時報告"

系統處理：
• 歷史: [前面8條記錄]
• 只保留最近5輪作為處理上下文
• 情境分類: "處置說明"
• 範例選擇: 程序說明回應
• 考慮患者可能的關切

最終歷史記錄：
conversation_history = [
    "護理人員: 王爺爺早安，今天感覺怎麼樣？",
    "王大明: 早安護士小姐，還不錯啦",
    "護理人員: 有沒有覺得發燒或不舒服？", 
    "王大明: 好像有點熱熱的",
    "護理人員: 那我幫您量個體溫好嗎？",
    "王大明: 好的，麻煩妳了",
    "護理人員: 體溫37.8度，確實有點發燒呢",
    "王大明: 難怪覺得有點熱",
    "護理人員: 我先記錄下來，等醫師查房時報告",
    "王大明: 好的，謝謝護士"
]

系統學習成果：
===============
• ExampleSelector 學習到"感覺詢問→症狀確認→測量→結果"的對話模式
• 提升了症狀相關範例的選擇準確性
• 記錄了成功的多輪對話案例
• 為未來類似場景提供參考
```

---

## 限制與改進建議

### 1. 當前限制分析

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                              系統限制與改進方向                              ║
╠══════════════════════════════════════════════════════════════════════════════╣
║                                                                              ║
║  🚫 主要限制                                                                ║
║  ┌─────────────────────────────────────────────────────────────────┐        ║
║  │                                                                   │        ║
║  │  1. 記憶窗口限制                                                │        ║
║  │  ──────────────────                                             │        ║
║  │  問題：硬編碼5輪限制，重要早期資訊可能丟失                     │        ║
║  │  影響：長對話中的一致性和連貫性下降                            │        ║
║  │  案例：10輪對話後，患者初始症狀描述被遺忘                      │        ║
║  │                                                                   │        ║
║  │  2. 缺乏複雜推理                                                │        ║
║  │  ──────────────────                                             │        ║
║  │  問題：主要基於範例匹配，缺乏邏輯推理                          │        ║
║  │  影響：難處理複雜醫療場景                                      │        ║
║  │  案例：無法推理"頭痛+發燒+頸硬"可能是腦膜炎                   │        ║
║  │                                                                   │        ║
║  │  3. 個人化程度有限                                              │        ║
║  │  ──────────────────                                             │        ║
║  │  問題：無法學習特定用戶的偏好和習慣                            │        ║
║  │  影響：對話體驗的個性化不足                                    │        ║
║  │  案例：無法記住某護理人員偏好簡短回應                          │        ║
║  │                                                                   │        ║
║  │  4. 情緒狀態管理簡單                                            │        ║
║  │  ──────────────────────                                         │        ║
║  │  問題：只有基本狀態，缺乏情緒細節                              │        ║
║  │  影響：無法適應患者的情緒變化                                  │        ║
║  │  案例：焦慮、沮喪、憤怒等情緒無法細緻處理                      │        ║
║  └─────────────────────────────────────────────────────────────────┘        ║
║                                                                              ║
║  💡 改進建議                                                                ║
║  ┌─────────────────────────────────────────────────────────────────┐        ║
║  │                                                                   │        ║
║  │  短期改進 (1-3個月)                                              │        ║
║  │  ═══════════════════════                                         │        ║
║  │                                                                   │        ║
║  │  1. 動態窗口大小                                                │        ║
║  │  ──────────────────                                             │        ║
║  │  • 可配置的歷史窗口大小                                        │        ║
║  │  • 基於對話復雜度自動調整                                      │        ║
║  │  • 重要資訊標記與保留機制                                      │        ║
║  │                                                                   │        ║
║  │  實現方案：                                                     │        ║
║  │  def _format_conversation_history(self, window_size=None):      │        ║
║  │      size = window_size or self.config.get('history_window', 5)│        ║
║  │      return self.conversation_history[-size:]                   │        ║
║  │                                                                   │        ║
║  │  2. 增強範例選擇                                                │        ║
║  │  ──────────────────                                             │        ║
║  │  • 添加時間感知的範例權重                                      │        ║
║  │  • 實施範例品質動態評估                                        │        ║
║  │  • 支援多模態範例（文本+結構化資料）                           │        ║
║  │                                                                   │        ║
║  │  3. 改進狀態管理                                                │        ║
║  │  ──────────────────                                             │        ║
║  │  • 添加情緒維度：焦慮、困惑、配合度                           │        ║
║  │  • 實施狀態轉換規則                                            │        ║
║  │  • 狀態歷史追蹤                                                │        ║
║  │                                                                   │        ║
║  │  長期改進 (6-12個月)                                             │        ║
║  │  ═══════════════════════                                         │        ║
║  │                                                                   │        ║
║  │  1. 分層記憶系統                                                │        ║
║  │  ──────────────────                                             │        ║
║  │  • 短期記憶：當前對話窗口                                      │        ║
║  │  • 中期記憶：會話摘要                                          │        ║
║  │  • 長期記憶：患者檔案                                          │        ║
║  │                                                                   │        ║
║  │  架構設計：                                                     │        ║
║  │  ┌─────────────────┐   ┌─────────────────┐                    │        ║
║  │  │  短期記憶       │   │  中期記憶       │                    │        ║
║  │  │  (5-10輪)      │──▶│  (會話摘要)     │                    │        ║
║  │  └─────────────────┘   └─────────────────┘                    │        ║
║  │           │                      │                              │        ║
║  │           └──────────────────────┼──────────┐                  │        ║
║  │                                  ▼          ▼                  │        ║
║  │                          ┌─────────────────┐                   │        ║
║  │                          │  長期記憶       │                   │        ║
║  │                          │  (患者檔案)     │                   │        ║
║  │                          └─────────────────┘                   │        ║
║  │                                                                   │        ║
║  │  2. 知識圖譜整合                                                │        ║
║  │  ──────────────────                                             │        ║
║  │  • 醫療知識圖譜                                                │        ║
║  │  • 症狀關聯推理                                                │        ║
║  │  • 因果關係分析                                                │        ║
║  │                                                                   │        ║
║  │  3. 個人化學習                                                  │        ║
║  │  ──────────────────                                             │        ║
║  │  • 用戶偏好建模                                                │        ║
║  │  • 對話風格適應                                                │        ║
║  │  • 個性化範例庫                                                │        ║
║  │                                                                   │        ║
║  │  4. 多模態對話                                                  │        ║
║  │  ──────────────────                                             │        ║
║  │  • 語音輸入/輸出                                               │        ║
║  │  • 視覺資訊整合                                                │        ║
║  │  • 生理數據整合                                                │        ║
║  └─────────────────────────────────────────────────────────────────┘        ║
║                                                                              ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

### 2. 具體改進實施方案

```python
# 改進方案 1: 動態歷史窗口
# ==========================

class EnhancedDialogueManager(DialogueManagerDSPy):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.config = {
            'base_history_window': 5,
            'max_history_window': 15,
            'important_keywords': ['症狀', '疼痛', '發燒', '過敏'],
            'adaptive_window': True
        }
        self.important_messages = []  # 重要資訊標記
    
    def _format_conversation_history_enhanced(self):
        """增強版歷史格式化"""
        if not self.config['adaptive_window']:
            return self.conversation_history[-self.config['base_history_window']:]
        
        # 動態調整窗口大小
        window_size = self._calculate_adaptive_window_size()
        
        # 優先保留重要對話
        important_indices = self._get_important_message_indices()
        recent_messages = self.conversation_history[-window_size:]
        
        # 合併重要資訊和最近資訊
        combined_history = self._merge_important_and_recent(
            important_indices, recent_messages, window_size
        )
        
        return combined_history
    
    def _calculate_adaptive_window_size(self):
        """根據對話複雜度計算窗口大小"""
        base_size = self.config['base_history_window']
        max_size = self.config['max_history_window']
        
        # 考慮因素：
        # 1. 對話輪次
        # 2. 重要資訊密度
        # 3. 情境複雜度
        
        complexity_score = self._assess_dialogue_complexity()
        adaptive_size = min(base_size + complexity_score, max_size)
        
        return adaptive_size
    
    def _assess_dialogue_complexity(self):
        """評估對話複雜度"""
        score = 0
        
        # 檢查重要關鍵字出現次數
        recent_history = self.conversation_history[-10:]
        keyword_count = sum(
            1 for msg in recent_history 
            for keyword in self.config['important_keywords']
            if keyword in msg
        )
        score += min(keyword_count, 5)
        
        # 檢查狀態轉換頻率
        if hasattr(self, 'state_history'):
            recent_states = self.state_history[-5:]
            unique_states = len(set(recent_states))
            score += unique_states
        
        return score


# 改進方案 2: 分層記憶系統
# ==========================

class LayeredMemorySystem:
    def __init__(self):
        self.short_term = ShortTermMemory(window_size=10)
        self.medium_term = MediumTermMemory()
        self.long_term = LongTermMemory()
    
    def update(self, user_input, response, context):
        """更新所有記憶層"""
        # 短期記憶：直接添加
        self.short_term.add(user_input, response, context)
        
        # 中期記憶：會話摘要
        if self.short_term.should_summarize():
            summary = self.short_term.create_summary()
            self.medium_term.add_summary(summary)
        
        # 長期記憶：重要資訊提取
        important_info = self._extract_important_info(
            user_input, response, context
        )
        if important_info:
            self.long_term.update(important_info)
    
    def retrieve_context(self, query, max_items=5):
        """檢索相關上下文"""
        context = []
        
        # 短期記憶（最高優先級）
        short_term_items = self.short_term.get_relevant(query, max_items//2)
        context.extend(short_term_items)
        
        # 中期記憶（中等優先級）
        remaining = max_items - len(context)
        if remaining > 0:
            medium_term_items = self.medium_term.get_relevant(query, remaining//2)
            context.extend(medium_term_items)
        
        # 長期記憶（最低優先級，但重要）
        remaining = max_items - len(context)
        if remaining > 0:
            long_term_items = self.long_term.get_relevant(query, remaining)
            context.extend(long_term_items)
        
        return context


# 改進方案 3: 知識圖譜整合
# ==========================

class MedicalKnowledgeIntegration:
    def __init__(self):
        self.symptom_graph = self._load_symptom_graph()
        self.disease_patterns = self._load_disease_patterns()
        self.reasoning_engine = MedicalReasoningEngine()
    
    def enhance_context_classification(self, user_input, history):
        """增強情境分類"""
        # 基本分類
        basic_context = self.basic_classifier(user_input, history)
        
        # 醫療知識增強
        medical_context = self._medical_context_analysis(user_input, history)
        
        # 融合結果
        enhanced_context = self._fuse_contexts(basic_context, medical_context)
        
        return enhanced_context
    
    def _medical_context_analysis(self, user_input, history):
        """醫療知識分析"""
        # 症狀提取
        symptoms = self._extract_symptoms(user_input)
        
        # 歷史症狀分析
        historical_symptoms = self._analyze_historical_symptoms(history)
        
        # 關聯分析
        related_conditions = self.reasoning_engine.analyze(
            current_symptoms=symptoms,
            historical_symptoms=historical_symptoms
        )
        
        return {
            'symptoms': symptoms,
            'related_conditions': related_conditions,
            'urgency_level': self._assess_urgency(symptoms)
        }
```

---

## 總結

DSPy 的 dialogue 系統與 example 系統具有以下關係特點：

### ✅ 現有能力：
1. **完整多輪對話支援**：透過 `conversation_history` 維護對話連續性
2. **上下文感知**：歷史影響情境分類和範例選擇
3. **智能範例整合**：基於對話脈絡動態選擇相關範例
4. **品質保證機制**：多層驗證確保回應品質

### ⚠️ 主要限制：
1. **記憶窗口限制**：硬編碼5輪限制
2. **複雜推理不足**：主要基於範例匹配
3. **個人化程度有限**：缺乏用戶偏好學習
4. **長期記憶缺失**：無法維護長期對話狀態

### 🚀 改進潛力：
系統架構設計良好，具備擴展多輪對話能力的基礎，通過實施分層記憶、知識圖譜整合等改進，可顯著提升多輪對話的智能化程度。

<function_calls>
<invoke name="TodoWrite">
<parameter name="todos">[{"content": "Analyze dialogue-related components in src/core/dspy/", "status": "completed", "activeForm": "Analyzing dialogue-related components in src/core/dspy/"}, {"content": "Examine multi-turn dialogue capabilities", "status": "completed", "activeForm": "Examining multi-turn dialogue capabilities"}, {"content": "Map relationships between dialogue and example systems", "status": "completed", "activeForm": "Mapping relationships between dialogue and example systems"}, {"content": "Create comprehensive ASCII diagrams", "status": "completed", "activeForm": "Creating comprehensive ASCII diagrams"}, {"content": "Document findings in markdown", "status": "completed", "activeForm": "Documenting findings in markdown"}]